<!doctype html><html lang="en-US"><head><link href="/assets/fonts/Montserrat-VariableFont_wght.woff2" rel="preload" type="font/woff2" as="font" crossorigin=""><meta charset="utf-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>The Domain Generation Algorithm of BazarLoader - A DGA based on the Emercoin TLD .bazar</title><meta content="BazarBackdoor is a module of the dreaded TrickBot Trojan. It is mostly used to gain a foothold in compromised enterprise networks." name="description" property="og:description"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="en_US" property="og:locale"><meta content="./assets/img/front/bazaar-800.jpeg" property="og:image"><meta content="website" property="og:type"><meta content="Binary Reverse Engineering Blog" property="og:site_name"><meta content="The Domain Generation Algorithm of BazarLoader - A DGA based on the Emercoin TLD .bazar" property="og:title"><meta content="summary" name="twitter:card"><meta content="@viql" name="twitter:site"><meta content="@viql" name="twitter:creator"><meta content="The Domain Generation Algorithm of BazarLoader - A DGA based on the Emercoin TLD .bazar" name="twitter:title"><meta content="BazarBackdoor is a module of the dreaded TrickBot Trojan. It is mostly used to gain a foothold in compromised enterprise networks." name="twitter:description"><meta content="https://bin.re/assets/img/front/bazaar-800.jpeg" name="twitter:image"><link href="/assets/css/common-bb493b.css" rel="stylesheet"><link href="feed.xml" rel="alternate" type="application/atom+xml" title="Atom feed for the Blog"><link href="/assets/css/blog-a83391.css" rel="stylesheet"><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><link href="/apple-touch-icon-192x192.png" rel="apple-touch-icon" sizes="192x192"><link href="/apple-touch-icon-512x512.png" rel="apple-touch-icon" sizes="512x512"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon"><noscript><style>img.lazyload {
          display: none;
        }</style></noscript><script defer src="/assets/js/all.min-a1c570.js"></script></head><body class="a b7"><div class="b"><div class="d"><div class="f e"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-close" xlink:href="/assets/svg/icons.svg#icon-close"></use></svg></div><div class="h"><ul class="i j sidebar"><li class="q r"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Varia<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul></div></div></div><div id="aw"><div class="w"><header class="y x"><nav class="z a0"><a href="/"><span class="a1"><!-- Generator: Adobe Illustrator 25.0.0, SVG Export Plug-In  --> <svg viewBox="0 0 86.4 20.21" height="20.21px" style="overflow:visible;enable-background:new 0 0 86.4 20.21;" version="1.1" width="86.4px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g><path class="a2" d="M28.56,5.13c-1.99,0-2.87-1.12-2.87-2.57c0-1.5,0.9-2.57,2.87-2.57c2.02,0,2.95,1.07,2.95,2.57
    C31.51,4.01,30.58,5.13,28.56,5.13z M25.96,19.94V6.47h5.22v13.46H25.96z"></path><path class="a2" d="M43.69,19.94v-7.92c0-1.23-0.27-1.91-1.59-1.91c-0.6,0-1.53,0.3-2.24,0.76v9.07H34.6V6.45h4.89l0.08,1.31
    l0.16,0.05c1.58-1.12,3.5-1.69,4.78-1.69c3.47,0,4.42,1.91,4.42,4.86v8.96H43.69z"></path><path class="a2" d="M54.33,20.15c-1.83,0-2.62-1.01-2.62-2.37c0-1.37,0.82-2.35,2.62-2.35c1.86,0,2.68,0.98,2.68,2.35
    C57,19.14,56.16,20.15,54.33,20.15z"></path><path class="a2" d="M65.14,9.23c1.58-1.69,3.85-3.17,5.49-3.17c0.63,0,0.79,0.49,0.79,1.09c0,1.45-0.87,4.29-1.58,5.3l-4.51-0.57
    v8.06h-5.21V6.45h5.16c0,0.66-0.14,2.08-0.25,2.7L65.14,9.23z"></path><path class="a2" d="M86.4,12.78v1.2h-8.63c0.03,1.72,1.07,2.4,3.03,2.4c1.34,0,3-0.35,4.34-0.76l0.98,3.2
    c-1.94,1.04-4.34,1.39-6.25,1.39c-5.9,0-7.32-3.33-7.32-6.99c0-3.41,1.58-7.13,7.07-7.13C85.74,6.09,86.4,9.78,86.4,12.78z
     M77.82,11.52h3.9c-0.03-1.31-0.41-2.29-1.83-2.29C78.4,9.23,77.93,10.32,77.82,11.52z"></path><path class="a2" d="M6.92,12.81"></path><path class="a2" d="M17.24,6.06c-0.79,0-2.43,0.29-3.87,1.3c0-0.14-0.06-2.69-0.06-3.07V0.27H8.12v9.28
    c2.71-0.69,4.54-1.87,5.24-2.18v3.06c-0.85,0.55-4.15,2.11-5.24,2.44v5.86c2.62,1.28,6.12,1.48,7.54,1.48
    c5.79,0,7.16-3.33,7.16-7.02C22.82,9.07,21.45,6.06,17.24,6.06z M15.41,16.6c-0.54,0-1.31-0.08-2.05-0.38v-5.79
    c0.66-0.33,1.45-0.65,2.16-0.65c1.01,0,2.1,0.35,2.1,3.47C17.63,16.14,16.59,16.6,15.41,16.6z"></path><path class="a2" d="M8.12,9.55c-1.03,0.23-2.56,0.51-3.66,0.23l0-3.09L0,11.57l4.51,4.88l0-3.13c1.38,0.17,2.69-0.23,3.61-0.45
    V9.55z"></path></g></svg></span></a><div class="a3"><button class="a2 a4" id="ax"><svg height="20px" version="1.1" width="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewport="0 0 20 20"><path class="a5" d="M2.28,15.89l1.57-1.61l1.24,1.24l-1.57,1.61L2.28,15.89z M8.86,19.33v-2.61h1.74v2.61H8.86z M9.73,4.35
	c1.46,0,2.71,0.52,3.75,1.55s1.55,2.28,1.55,3.75s-0.52,2.71-1.55,3.75c-1.03,1.03-2.28,1.55-3.75,1.55s-2.71-0.52-3.75-1.55
	s-1.55-2.28-1.55-3.75S4.95,6.93,5.98,5.9S8.26,4.35,9.73,4.35z M16.81,8.77h2.65v1.78h-2.65V8.77z M14.36,15.52l1.24-1.2l1.57,1.57
	l-1.24,1.24L14.36,15.52z M17.18,3.43l-1.57,1.57l-1.24-1.24l1.57-1.57L17.18,3.43z M10.6,0v2.61H8.86V0C8.86,0,10.6,0,10.6,0z
	 M2.65,8.77v1.78H0V8.77H2.65z M5.09,3.77L3.85,5.01L2.28,3.43l1.24-1.24L5.09,3.77z"></path><path class="a6" d="M14.18,14.19c3.31-3.31,3.31-8.67,0-11.97C13.06,1.1,11.7,0.36,10.26,0c2.2,2.88,1.98,7.01-0.65,9.65
	C6.99,12.26,2.88,12.49,0,10.33c0.37,1.41,1.1,2.76,2.21,3.87C5.52,17.5,10.88,17.5,14.18,14.19z M7.1,2.48H6.36l0.52,0.52
	L6.55,3.34L6.03,2.81v0.74H5.56V2.81L5.04,3.34L4.71,3.01l0.52-0.52H4.49V2.02h0.74L4.71,1.49l0.33-0.33l0.52,0.52V0.95h0.47v0.74
	l0.52-0.52l0.33,0.33L6.36,2.02H7.1V2.48z M0.94,3.94c0,0.26-0.21,0.47-0.47,0.47S0,4.2,0,3.94s0.21-0.47,0.47-0.47
	S0.94,3.68,0.94,3.94z M3.88,5.66c0,0.29-0.24,0.53-0.53,0.53S2.83,5.95,2.83,5.66c0-0.29,0.24-0.53,0.53-0.53S3.88,5.36,3.88,5.66z
	"></path></svg></button><ul class="i j a7"><li class="q"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Varia<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t r"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul><div class="f a8 a9"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bars" xlink:href="/assets/svg/icons.svg#icon-bars"></use></svg></div></div></nav></header><div class="b8"><noscript>&lt;img src="/assets/img/header/bazaar-640.jpeg" class="-minfy-post__title-image"/&gt;</noscript><img alt="cover image for post 'The Domain Generation Algorithm of BazarLoader'" class="lazyload b9" data-src="/assets/img/header/bazaar-640.jpeg" data-srcset="/assets/img/header/bazaar-1830.webp 1830w,
/assets/img/header/bazaar-1400.webp 1400w,
/assets/img/header/bazaar-1080.webp 1080w,
/assets/img/header/bazaar-830.webp 830w,
/assets/img/header/bazaar-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMjMzIj48cGF0aCBmaWxsPSIjNGMzMjIzIiBkPSJNMCAwaDMwMHYyMzNIMHoiLz48ZyBmaWxsLW9wYWNpdHk9Ii41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNiAuNilzY2FsZSgxLjE3MTg4KSI+PGNpcmNsZSByPSIxIiBmaWxsPSIjZjdlY2Q1IiB0cmFuc2Zvcm09Im1hdHJpeCgtMjEuNjIzNjMgLTIxMC40NzY5NyA1My40MjI5MiAtNS40ODg0NyAxMjMgMTYzLjQpIi8+PGNpcmNsZSByPSIxIiBmaWxsPSIjZmZlIiB0cmFuc2Zvcm09InJvdGF0ZSgtMTE1IDcxLjYgLTguOClzY2FsZSgxNi45Mjg3NCAzNi44NTM2NikiLz48Y2lyY2xlIHI9IjEiIGZpbGw9IiNmM2VkZTAiIHRyYW5zZm9ybT0ibWF0cml4KDEzLjgwMDY3IDE4LjQ2NjQ4IC0zMy44NDEyNyAyNS4yOTA4MiAxMTQuMiAxNTIuOCkiLz48Y2lyY2xlIGN4PSIyNDUiIGN5PSIxMjgiIHI9Ijk3IiBmaWxsPSIjNzI1NDQzIi8+PGNpcmNsZSBjeD0iMzYiIGN5PSI3OSIgcj0iNDQiIGZpbGw9IiMwZTA4MDEiLz48cGF0aCBmaWxsPSIjMTEwNzAwIiBkPSJtMTIzLTE2IDkgNTAgMzMtOXoiLz48cGF0aCBmaWxsPSIjYmFhZjlmIiBkPSJNMTQ1IDI5aDI5djM1aC0yOXoiLz48Y2lyY2xlIHI9IjEiIGZpbGw9IiNhYjk1NjkiIHRyYW5zZm9ybT0ibWF0cml4KDIxLjYzOTg1IC02LjY5ODY1IDE4Ljk5OTAyIDYxLjM3NTkyIDYzLjcgMCkiLz48Y2lyY2xlIHI9IjEiIGZpbGw9IiM5YjliODgiIHRyYW5zZm9ybT0ibWF0cml4KC0xMi4yODQ0NCAxNy4zNDk5NCAtMTguNzkzNzkgLTEzLjMwNjc0IDU4LjQgMTc5LjgpIi8+PHBhdGggZmlsbD0iIzU4MzYxZiIgZD0iTTQ1IDYzaDMydjk3SDQ1eiIvPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHg9Ii0uNSIgeT0iLS41IiBmaWxsPSIjZmZiNzhiIiB0cmFuc2Zvcm09InJvdGF0ZSgtODUgMTU0IC05NS44KXNjYWxlKDE4IDIzKSIvPjxwYXRoIGZpbGw9IiM3NTY5NTciIGQ9Im0yNTYgMjE0IDE1LTEwNi0xNjcgODZ6Ii8+PHBhdGggZmlsbD0iIzFlMGUwNSIgZD0ibTIwMiAxMzEgNjktMTItNjQtNjJ6Ii8+PHBhdGggZmlsbD0iI2ZhZjdlZSIgZD0iTTc5IDEyMGgzOHYxN0g3OXoiLz48ZWxsaXBzZSBjeD0iOSIgY3k9IjMyIiBmaWxsPSIjMGUwZDA5IiByeD0iMjUiIHJ5PSIxMTciLz48cGF0aCBmaWxsPSIjODE3NzczIiBkPSJtMTA5IDgyIDEwIDU0TDE5NiA4eiIvPjxwYXRoIGQ9Im0yNTAuMy0xNiAxMy4xIDE3My42LTE3LjEtMTA2LjUgMS45LTcuOXoiLz48cGF0aCBmaWxsPSIjOTk5NzgzIiBkPSJNNiAyMDAuMSAzMy45IDE4OWwtMjIuNC00LjQtMjcuNS01OS44eiIvPjxwYXRoIGZpbGw9IiNkNWNhYjYiIGQ9Ik0yNDggMTI1aDIzbC0yNyAzNHoiLz48Y2lyY2xlIGN4PSIxMDgiIGN5PSI1MSIgcj0iMjEiIGZpbGw9IiNmZmYxYzkiLz48cGF0aCBmaWxsPSIjYjU3YjYzIiBkPSJtMjQ4IDI1LTM0IDM2IDE2LTQyeiIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iIzI2MTEwYiIgdHJhbnNmb3JtPSJtYXRyaXgoLTIuOTA3NDggLTkuMTEwMzMgMjEuMjQxMzggLTYuNzc4OTkgMTgwLjQgMTMzKSIvPjxwYXRoIGZpbGw9IiNmZGZhZWUiIGQ9Im0xNTAuMyAxNDUuOC0zOS41IDE4LjcgMTAgNSAyLjctNTUuM3oiLz48cGF0aCBmaWxsPSIjNDMzOTJiIiBkPSJtMTQyLjEtMTIuMyA3MC43IDI4LjctNzYuMiAxNy43LTE2LjgtMS42eiIvPjxwYXRoIGZpbGw9IiM1OTU0NDYiIGQ9Ik0yMCAxODJoNzh2MTdIMjB6Ii8+PHBhdGggZmlsbD0iIzg5NjY0OCIgZD0iTTcyIDE1OSA1NyA5OWw0OCA2MXoiLz48Y2lyY2xlIHI9IjEiIGZpbGw9IiNiMWFiODciIHRyYW5zZm9ybT0icm90YXRlKDI1LjYgMjIuNCAxMDguOSlzY2FsZSgyNy42NjU1MiA5LjExODIzKSIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iIzQ3MjQxNCIgdHJhbnNmb3JtPSJyb3RhdGUoMTE5IDU0LjQgMTU3KXNjYWxlKDQwLjQ4MTA0IDkuNDA3MDYpIi8+PHBhdGggZmlsbD0iIzVkNGI0MiIgZD0ibTExMC4xIDEzMC4xLTI1LjUtMjMuMiAyMi43LTE5LjUtMTAuNSAzNnoiLz48cGF0aCBmaWxsPSIjYmNhZDhmIiBkPSJtMjIwLjYgMTQ3LjMtMjQtMTAuMiAyLjgtNi40IDI0IDEwLjJ6Ii8+PC9nPjwvc3ZnPg=="></div><main class="y aa"><article class="z ae ac ba"><div class="bb"><h1 class="bc">The Domain Generation Algorithm of BazarLoader</h1><span class="bo">A DGA based on the Emercoin TLD .bazar</span></div><div class="bd"><ul class="i be"><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-calendar-o" xlink:href="/assets/svg/icons.svg#icon-calendar-o"></use></svg> <a href="https://bin.re/2020/07">July 11, 2020</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-book" xlink:href="/assets/svg/icons.svg#icon-book"></use></svg> <a href="/category/reverse-engineering">reverse engineering</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-tags" xlink:href="/assets/svg/icons.svg#icon-tags"></use></svg> <span class="bf"><a href="/tag/dga" class="bg">dga</a> <a href="/tag/malware-analysis" class="bg">malware analysis</a></span></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-comments-o" xlink:href="/assets/svg/icons.svg#icon-comments-o"></use></svg> no comments</li></ul><div class="bh"><span class="bj">Table of Contents</span><ul class="i bk"><li><a href="#sample">Sample</a></li><li><a href="#dga-disassembly">DGA Disassembly</a></li><li><a href="#ZgotmplZ">Step 1: First Six Letters</a></li><li><a href="#ZgotmplZ">Step 2: Seeding</a></li><li><a href="#ZgotmplZ">Step 3: Last Six Letters</a></li><li><a href="#python-reimplementation">Python Reimplementation</a></li><li><a href="#regex">Regex</a></li><li><a href="#characteristics">Characteristics</a></li><li><a href="#domain-to-seed">Domain to Seed</a></li><li><a href="#registered-domains">Registered Domains</a></li><li><a href="#sinkholing">Sinkholing</a></li></ul><div><span class="bj">Disclaimer<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-exclamation-triangle" xlink:href="/assets/svg/icons.svg#icon-exclamation-triangle"></use></svg></span><p>These are just unpolished notes. The content likely lacks clarity and structure; and the results might not be adequately verified and/or incomplete.</p></div><span class="bj">Changes</span><ul class="i"><li>2020-07-14 23:10:00: link to blog post about buggy DGA, section about registered domains</li><li>2020-07-19 16:33:00: link to article by Cybereason and renamed BazarBackdoor to BazarLoader</li><li>2020-11-10 15:46: Fixed the regular expressions (thanks to Luca Corbatto).</li></ul><span class="bj">Aliases</span><p>The malware in this blog post is also known as <span class="bl">BazarBackdoor</span>, <span class="bl">Team9Backdoor</span>, <span class="bl">BazDor</span>, <span class="bl">BazarLoader</span> and <span class="bl">BazaLoader</span></p><div><span class="bj">DGArchive</span><p>The DGA in this blog post has been implemented by the <a href="https://dgarchive.caad.fkie.fraunhofer.de/" class="bm">DGArchive</a> project.</p></div><div><span class="bj">Malpedia</span><p>For more information about the malware in this blog post see the <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor" class="bm">Malpedia entry on BazarBackdoor</a>.</p></div><div><span class="bj">URLhaus</span><p><a href="https://urlhaus.abuse.ch/browse/tag/BazarLoader/" class="bm">This page</a> lists malware URLs that are tagged with BazarLoader.</p></div><div><span class="bj">MalwareBazaar</span><p>You can download bazaloader samples from <a href="https://bazaar.abuse.ch/browse/tag/bazaloader/" class="bm">this page</a>.</p></div><div><span class="bj">Cover Image</span> Image by <a href="https://pixabay.com/users/TheUjulala-59978/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1627045">TheUjulala</a> from <a href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1627045">Pixabay</a></div><div><span class="bj">Related Posts</span> This is one of five blog posts on "Bazar Loader". Check out the other parts here:<ul class="i bn"><li><a href="/blog/the-buggy-dga-of-bazarbackdoor/">The Defective Domain Generation Algorithm of BazarLoader (July 15, 2020)</a></li><li><a href="/blog/next-version-of-the-bazarloader-dga/">Next Version of the Bazar Loader DGA (December 16, 2020)</a></li><li><a href="/blog/yet-another-bazarloader-dga/">Yet Another Bazar Loader DGA (January 23, 2021)</a></li><li><a href="/blog/a-bazarloader-dga-that-breaks-during-summer-months/">A BazarLoader DGA that Breaks Down in the Summer (August 9, 2021)</a></li></ul></div></div></div><div class="b6 bi"><p><strong>Edit 2020-07-19</strong>: Cybereason published an excellent article <a href="https://www.cybereason.com/blog/a-bazar-of-tricks-following-team9s-development-cycles">A Bazar of Tricks: Following Team9’s Development Cycles</a>. They only show the seeding part of the domain generation algorithm, however, the listing of generated bazar domains matches the algorithm in this blog post (apart from the first two domains <code>alztwfdicu.bazar</code> and <code>ocgjqlaspr.bazar</code> which are hardcoded). The article shows that the DGA is part of Bazar Loader, which will try to download Bazar Backdoor. I therefore renamed most instances of BazarBackdoor to BazarLoader.</p><p><strong>Edit 2020-07-14</strong>: I have documented some additions to the DGA of BazarLoader:</p><ul><li>There exists a version of BazarLoader with a faulty DGA. I documented it in a separate <a href="/blog/the-buggy-dga-of-bazarbackdoor">blog post</a>.</li><li>The attackers registered four of the DGA domains, which <a href="https://twitter.com/Securityinbits">@Securityinbits</a> long before I published this post. I listed them <a href="#registered-domains">here</a>.</li><li>The malware transforms the A RR of registered DGA domains, see the <a href="#sinkholing.">paragraph on sinkholing</a></li></ul><p>BazarLoader (also known as Bazar Loader, Bazar Backdoor or Team9 Backdoor) is a module of the dreaded TrickBot Trojan. It is mostly used to gain a foothold in compromised enterprise networks <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>. The malware is named after the C&amp;C domains with top level domain <em>.bazar</em>. This TLD is provided by EmerDNS, a peer-to-peer decentralized domain name system in OpenNIC. This makes it very difficult, if not impossible, for law enforcement to take over these domains.</p><p>BazarLoader has been using a handful of hard-coded domains such as <code>bestgame.bazar</code>, <code>forgame.bazar</code> or <code>newgame.bazar</code> in the past, but today a sample <a href="https://www.virustotal.com/gui/file/e77e27630277a31276539c379671f54095d6b735f0568a3c457ac6a189c4c5b4/">was uploaded to Virustotal</a> that tries a plethora of domains such as:</p><pre tabindex="0"><code>ecfgjkehhgjm.bazar
afhhjkakjhjm.bazar
beggklbjigkn.bazar
cfhhjkckjhjm.bazar
bdehklbighkn.bazar
dcegjldhggjn.bazar
adggjkaiigjm.bazar
dcghkldhihkn.bazar
dehhikdjjhim.bazar
ceegkkcjggkm.bazar
eeegjkejggjm.bazar
cfehjkckghjm.bazar
cehhimcjjhio.bazar
ddfgjldihgjn.bazar
afhijlakjijn.bazar
ccfgimchhgio.bazar
eefhklejhhkn.bazar
acgiimahiiio.bazar
ecghjkehihjm.bazar
cehiklcjjikn.bazar
</code></pre><p>These look like algorithmically generated — and it turns out they are. This blog post shows how the underlying domain generation algorithm works.</p><h2 id="sample">Sample</h2><p>I analysed the aforementioned sample from Virustotal:</p><dl><dt>MD5</dt><dd>fdffbfa1380ab1a0ee2e26ff1be432b1</dd><dt>SHA1</dt><dd>5a004286c5b97afd97beec4b1332777c494d6ff1</dd><dt>SHA256</dt><dd>e77e27630277a31276539c379671f54095d6b735f0568a3c457ac6a189c4c5b4</dd><dt>Size</dt><dd>288 KB (295424 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-06-12 09:35:14 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/e77e27630277a31276539c379671f54095d6b735f0568a3c457ac6a189c4c5b4/">MalwareBazaar</a>, <a href="https://www.capesandbox.com/analysis/24419/">Cape</a>, <a href="https://www.virustotal.com/gui/file/e77e27630277a31276539c379671f54095d6b735f0568a3c457ac6a189c4c5b4">VirusTotal</a></dd><dt>Filenames</dt><dd>BthCxn.exe, v86.exe_ (VirusTotal)</dd><dt>Detections</dt><dd><strong>MalwareBazaar</strong>: BazaLoader, <strong>Virustotal</strong>: 23/76 as of 2020-07-10 04:00:39 - Trojan:Win32/Trickbot.KB (Microsoft), Trojan.Trickbot!8.E313 (CLOUD) (Rising)</dd></dl><p>Many AV classify the sample as malicious, but only Microsoft and Rising also name the sample, both as <em>Trickbot</em> — which is at correct in the broader sense. The binary unpacks to this:</p><dl><dt>MD5</dt><dd>599b72d329b4b876390ae0567991da01</dd><dt>SHA1</dt><dd>a8128b487bf6efd80b78c453e24a3447208008dd</dd><dt>SHA256</dt><dd>6b24ebfb84665cb844410ec9f948cfcf7f6d08f4ede16d52930c53236390848f</dd><dt>Size</dt><dd>141 KB (144896 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-06-12 09:34:11 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/6b24ebfb84665cb844410ec9f948cfcf7f6d08f4ede16d52930c53236390848f/">MalwareBazaar</a>, <a href="https://www.virustotal.com/gui/file/6b24ebfb84665cb844410ec9f948cfcf7f6d08f4ede16d52930c53236390848f">VirusTotal</a></dd><dt>Filenames</dt><dd><em>none</em></dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 10/75 as of 2020-07-10 13:52:07</dd></dl><p>The detection for this sample is worse and none of the AV products assigns a non-generic name. The sample will finally inject the following executable, which only 3 out of 76 products even classify as malicious.</p><dl><dt>MD5</dt><dd>d1c4d25673be94db051dcd5271c64ae1</dd><dt>SHA1</dt><dd>cc4d30072bbd16fbdc387eb546aeb4dc38a5ea4a</dd><dt>SHA256</dt><dd>b4b7f0fd63cda1269ee937fa398fb80b6655d205066e6593fefceda7e3b09f6b</dd><dt>Size</dt><dd>132 KB (135168 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-06-11 11:16:31 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/b4b7f0fd63cda1269ee937fa398fb80b6655d205066e6593fefceda7e3b09f6b/">MalwareBazaar</a>,<a href="https://www.virustotal.com/gui/file/b4b7f0fd63cda1269ee937fa398fb80b6655d205066e6593fefceda7e3b09f6b">VirusTotal</a></dd><dt>Filenames</dt><dd><em>none</em></dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 3/76 as of 2020-07-10 13:52:05</dd></dl><h2 id="dga-disassembly">DGA Disassembly</h2><p>The domain generation algorithm of BazarLoader is in a single function, including seeding (click to enlarge):</p><p><a href="assets/dga_full.png"><noscript>&lt;img src="assets/dga_small.png" class=""/&gt;</noscript><img alt="large" class="lazyload" data-src="assets/dga_small.png" data-srcset="assets/dga_small-1x.webp 400w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMTIzMyIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6I05hTk5hTk5hTiI+PC9zdmc+" sizes="(max-width: 400px) 100vw, 400px"></a></p><p>The algorithm roughly consists of these three steps:</p><ol><li>Determine the first six letters of the second level domain at random.</li><li>Generate a seed based on the current date</li><li>Calculate the last six letters of the second level domain based on the first six and the seed.</li></ol><h3 id="step-1-first-six-letters">Step 1: First Six Letters</h3><p>The (simplified) decompilation of the first step is as follows:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">GetTickCount</span><span class="p">()</span> <span class="o">%</span> <span class="mi">25</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">i_1</span> <span class="o">=</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">domain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i_1</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="sc">'a'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">);</span>
</span></span></code></pre></div><p>The function <code>GetTickCount</code> usually doesn’t bode well for DGAs: since this functions is largely unpredictable, it almost always means that the generated domains will be unpredictable as well. However, this algorithm is different. The tick count is mapped to a value between 0 and 24, which is then divided by 6+i. The division shrinks down the range of numbers, and ultimately the range of potential letters. The character set is also offset by double the loop index, leading to these choices of letters:</p><table><thead><tr><th>index</th><th>random number range</th><th>potential letters</th></tr></thead><tbody><tr><td>0</td><td>0–4</td><td>abcde</td></tr><tr><td>1</td><td>0–3</td><td>cdef</td></tr><tr><td>2</td><td>0–3</td><td>efgh</td></tr><tr><td>3</td><td>0–2</td><td>ghi</td></tr><tr><td>4</td><td>0–2</td><td>ijk</td></tr><tr><td>5</td><td>0–2</td><td>klm</td></tr></tbody></table><p>So even though the exact letters can’t be predicted, there are only 2160 combinations. Since the malware continuously tries to contact newly generated domains, registering a few of the 2160 domains is probably enough to get lucky with <code>GetTickCount</code> within a couple of minutes of malware runtime.</p><h3 id="step-2-seeding">Step 2: Seeding</h3><p>Seeding is based on on the current date, which is determined by <code>GetDateFormatA</code>.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">seeding_done</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">GetDateFormatA</span><span class="p">(</span><span class="n">LOCALE_INVARIANT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="n">i64</span><span class="p">,</span> <span class="mi">0</span><span class="n">i64</span><span class="p">,</span> <span class="n">lpCurrentDate</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">szMonth</span> <span class="o">=</span> <span class="n">lpCurrentDate</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">szYear</span> <span class="o">=</span> <span class="o">*&amp;</span><span class="n">lpCurrentDate</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">v15</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v17</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">str_to_int</span> <span class="o">=</span> <span class="n">resolve_api</span><span class="p">(</span><span class="mi">0</span><span class="n">i64</span><span class="p">,</span> <span class="mi">19</span><span class="n">i64</span><span class="p">,</span> <span class="mi">2865918183</span><span class="n">i64</span><span class="p">,</span> <span class="mi">534</span><span class="n">i64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">str_to_int</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">nYear</span> <span class="o">=</span> <span class="n">str_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">szYear</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="n">nYear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">str_to_int_0</span> <span class="o">=</span> <span class="n">resolve_api</span><span class="p">(</span><span class="mi">0</span><span class="n">i64</span><span class="p">,</span> <span class="mi">19</span><span class="n">i64</span><span class="p">,</span> <span class="mi">2865918183</span><span class="n">i64</span><span class="p">,</span> <span class="mi">534</span><span class="n">i64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">str_to_int_0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">nMonth</span> <span class="o">=</span> <span class="n">str_to_int_0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">szMonth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="n">nMonth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">LODWORD</span><span class="p">(</span><span class="n">nYearMinus18</span><span class="p">)</span> <span class="o">=</span> <span class="n">nYear</span> <span class="o">-</span> <span class="mi">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">wnsprintfA</span><span class="p">(</span><span class="n">szSeedStr</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s">"%.2d%d"</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span> <span class="o">-</span> <span class="n">nMonth</span><span class="p">),</span> <span class="n">nYearMinus18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">seeding_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The function <code>GetDateFormatA</code> with <code>LOCALE_INVARIANT</code> locale returns the current date formatted as <code>&lt;month&gt;/&lt;day&gt;/&lt;year&gt;</code>, so for example <code>07/10/2020</code> for July 10, 2020. The month and year are taken from this string and converted into integers. The month is then turned into a two-digit number by calculating <code>a = 12 - month</code> and padding it with zero if necessary. The year is transformed into a four-digit number according to <code>b = year - 18</code>. The two values are then concatenated into a string. For example, July 2020 turns into <code>052002</code>.</p><h3 id="step-3-last-six-letters">Step 3: Last Six Letters</h3><p>The last six characters of the second level domain are based on the seed and the first six letters:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">j</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">[...]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">szDomainPlusSix</span> <span class="o">=</span> <span class="n">szDomain</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ascii_code</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">szDomainPlusSix</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">szDomainPlusSix</span><span class="p">[</span><span class="n">szSeedStr</span> <span class="o">-</span> <span class="n">szDomain</span> <span class="o">-</span> <span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">ascii_code</span> <span class="o">&lt;</span> <span class="sc">'a'</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="n">ascii_code</span> <span class="o">=</span> <span class="sc">'z'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">szDomainPlusSix</span><span class="o">++</span> <span class="o">=</span> <span class="n">ascii_code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">--</span><span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span> <span class="n">j</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">szDomain</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></div><p>This simply treats each character of the seed string as an integer, and uses that to offset the characters of the first six letters to form the last six letters. For instance, let’s look at the seed string <code>052002</code> applied to the randomly picked first six letters <code>cfhiilc</code>:</p><ol><li>Add 0 to <code>c</code> to get <code>c</code>.</li><li>Add 5 to <code>f</code> to get <code>k</code>.</li><li>Add 2 to <code>h</code> to get <code>j</code>.</li><li>Add 0 to <code>i</code> to get <code>i</code>.</li><li>Add 0 to <code>i</code> to get <code>i</code>.</li><li>Add 2 to <code>l</code> to get <code>n</code>.</li></ol><p>The malware’s check if the letter falls before <code>a</code> is actualy not necessary, as the offset is always positive between 0 and 9. A check to see if the letter falls beyond <code>z</code> would be more reasonable, but is also unnecessary: the “largest” letter in the first half is “m”, which offset by 9 leads to “v”. The following image illustrates the procedure:</p><p><noscript>&lt;img src="assets/domain_generation.png" class=""/&gt;</noscript><img alt="Domain Generation" class="lazyload" data-src="assets/domain_generation.png" data-srcset="assets/domain_generation-1x.webp 519w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTkiIGhlaWdodD0iMjE1IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 519px) 100vw, 519px"></p><h2 id="python-reimplementation">Python Reimplementation</h2><p>When implemented in Python, the DGA looks something like this:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dga</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">month</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span>
</span></span><span class="line"><span class="cl">    <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
</span></span><span class="line"><span class="cl">    <span class="n">date_str</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{0:02d}{1:04d}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">12</span><span class="o">-</span><span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="o">-</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">valid_chars</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"abcde"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"cdef"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"efgh"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"ghi"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"ijk"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"klm"</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">valid_chars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">valid_chars</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">part1</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">valid_chars</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">domain</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">part1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">domain</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">date_str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">domain</span> <span class="o">+=</span> <span class="s2">".bazar"</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">domain</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">"__main__"</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-d"</span><span class="p">,</span> <span class="s2">"--date"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"date when domains are generated"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">dga</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="regex">Regex</h2><p>The possible letters per position is very limited. Assuming that the year is between 2020 and 2029, the domains match the following regular expression (<strong>Edit 2020-11-10</strong>: Fixed the regular expression, thanks to Luca Corbatto for providing the correct regex):</p><pre tabindex="0"><code>[a-e][c-f][e-h][g-i][i-k][k-m][a-f][c-o][g-j][g-i][i-l][k-v]\.bazar
</code></pre><h2 id="characteristics">Characteristics</h2><p>The following table summarizes the properties of BazarLoader’s DGA.</p><table><thead><tr><th>property</th><th>value</th></tr></thead><tbody><tr><td>type</td><td>TDD (time-dependent-deterministic), to some extend TDN (time-dependent non-deterministic)</td></tr><tr><td>generation scheme</td><td>arithmetic</td></tr><tr><td>seed</td><td>current date</td></tr><tr><td>domain change frequency</td><td>every month</td></tr><tr><td>domains per day</td><td>2160</td></tr><tr><td>sequence</td><td>random selection, might pick domains multiple times</td></tr><tr><td>wait time between domains</td><td>None</td></tr><tr><td>top level domain</td><td><code>.bazar</code></td></tr><tr><td>second level characters</td><td>a-v</td></tr><tr><td>regex</td><td><code>[a-e][c-f][e-h][g-i][i-k][k-m][a-f][c-o][g-j][i-k][k-m][k-v]\.bazar</code></td></tr><tr><td>second level domain length</td><td>12</td></tr></tbody></table><h2 id="domain-to-seed">Domain to Seed</h2><p>Since the function to determine the second half of the domain is reversible, the month and year can be calculated from the domains. I <a href="/projects/bazarbackdoor/">wrote a small Javascript form</a> that does just that. For those of you who block Javascript, here’s a screenshot. The same code in Python can also be found on <a href="https://github.com/baderj/domain_generation_algorithms/bazarbackdoor/">my GitHub page</a></p><p><noscript>&lt;img src="assets/gui.png" class=""/&gt;</noscript><img alt="Convert Domain Back to Date" class="lazyload" data-src="assets/gui.png" data-srcset="assets/gui-1x.webp 732w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzIiIGhlaWdodD0iMzM0IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 732px) 100vw, 732px"></p><h2 id="registered-domains">Registered Domains</h2><p>As far as I can tell, the attackers registered five domains using the Emercoin address ETQERUknhW2A5cBmfHN4VBqL7VGiFnKQRh. Also see tweets by <a href="https://twitter.com/malware_traffic/status/1253092725869760512">Brad @malware_traffic</a> and <a href="https://twitter.com/Securityinbits/status/1282630604798914565">Security-in-bits @Securityinbits</a>:</p><table><thead><tr><th>date</th><th>domain</th><th>valid for</th></tr></thead><tbody><tr><td>2020-05-18 10:24:32 UTC</td><td>cdghilckihin.bazar</td><td>May 2020</td></tr><tr><td>2020-05-18 10:24:32 UTC</td><td>cefgilclhgin.bazar</td><td>May 2020</td></tr><tr><td>2020-07-03 11:08:26 UTC</td><td>defikldjhikn.bazar</td><td>July 2020</td></tr><tr><td>2020-07-03 11:14:24 UTC</td><td>aeehjkajghjm.bazar</td><td>July 2020</td></tr><tr><td>2020-07-14 14:13:16 UTC</td><td>cdfhimcihhio.bazar</td><td>July 2020</td></tr></tbody></table><h2 id="sinkholing">Sinkholing</h2><p>The IP resource record of the DGA domains are XOR decrypted with key <code>0xFE</code> to get the real IP of the C2 servers. You can use <a href="/projects/bazarbackdoor/">this Javascript form</a> to calculate the transformation.</p><div class="footnotes" role="doc-endnotes"><hr><ol><li id="fn:1"><p><a href="https://blog.fox-it.com/2020/06/02/in-depth-analysis-of-the-new-team9-malware-family/">In-depth analysis of the new Team9 malware family</a>&nbsp;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:2"><p><a href="https://www.bleepingcomputer.com/news/security/bazarbackdoor-trickbot-gang-s-new-stealthy-network-hacking-malware/">BazarBackdoor: TrickBot gang’s new stealthy network-hacking malware</a>&nbsp;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:3"><p><a href="https://cybersecurity.att.com/blogs/labs-research/trickbot-bazarloader-in-depth">TrickBot BazarLoader In-Depth</a>&nbsp;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:4"><p><a href="https://www.trendmicro.com/vinfo/hk-en/security/news/cybercrime-and-digital-threats/group-behind-trickbot-spreads-fileless-bazarbackdoor">Group Behind TrickBot Spreads Fileless BazarBackdoor</a>&nbsp;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">↩︎</a></p></li></ol></div></div></article></main><footer><div><div class="y"><div class="z ae aj"><div class="ag ak al am"><h3>Links</h3><ul class="i an"><li><a href="http://www.twitter.com/viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-twitter" xlink:href="/assets/svg/icons.svg#icon-twitter"></use></svg> Twitter</a></li><li><a href="http://www.github.com/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-github" xlink:href="/assets/svg/icons.svg#icon-github"></use></svg> GitHub</a></li><li><a href="mailto:hello@bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-envelope-o" xlink:href="/assets/svg/icons.svg#icon-envelope-o"></use></svg> Mail</a></li><li><a href="https://keybase.io/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-keybase" xlink:href="/assets/svg/icons.svg#icon-keybase"></use></svg> Keybase</a></li><li><a href="/feed.xml" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-feed" xlink:href="/assets/svg/icons.svg#icon-feed"></use></svg> RSS</a></li><li><a href="https://threatcat.ch" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-threatcat" xlink:href="/assets/svg/icons.svg#icon-threatcat"></use></svg> Threatcat.ch</a></li><li><a href="https://infosec.exchange/@viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-mastodon" xlink:href="/assets/svg/icons.svg#icon-mastodon"></use></svg> Mastodon</a></li><li><a href="https://bsky.app/profile/viql.bsky.social" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bluesky" xlink:href="/assets/svg/icons.svg#icon-bluesky"></use></svg> Bluesky</a></li></ul></div><div class="ag ak al am"><div><h3>Categories</h3><ul class="i"><li><a href="/category/reverse-engineering">reverse-engineering</a> <span class="ao">(81)</span></li><li><a href="/category/tutorial">tutorial</a> <span class="ao">(14)</span></li><li><a href="/category/project-euler">project-euler</a> <span class="ao">(13)</span></li><li><a href="/category/misc">misc</a> <span class="ao">(2)</span></li><li><a href="/category/visualization">visualization</a> <span class="ao">(2)</span></li></ul></div></div><div class="ag ak al am a7"><div><h3>Tags</h3><span class="ap"><a href="/tag/malware-analysis" class="aq">malware-analysis <span class="ao">(42)</span></a><a href="/tag/dga" class="aq">dga <span class="ao">(36)</span></a><a href="/tag/crackmes" class="aq">crackmes <span class="ao">(23)</span></a><a href="/tag/practical-reverse-engineering" class="aq">practical-reverse-engineering <span class="ao">(16)</span></a><a href="/tag/math" class="aq">math <span class="ao">(15)</span></a><a href="/tag/project-euler" class="aq">project-euler <span class="ao">(13)</span></a><a href="/tag/python" class="aq">python <span class="ao">(12)</span></a><a href="/tag/upatre" class="aq">upatre <span class="ao">(4)</span></a><a href="/tag/visualization" class="aq">visualization <span class="ao">(4)</span></a><a href="/tag/d3js" class="aq">d3js <span class="ao">(3)</span></a></span> <a href="/tag/" class="ar">show all</a></div></div><div class="ag ak al am as"><div class="at"><div><h3>Blog Archive</h3><span class="au"><a href="/2013">2013</a><span class="ao">(20)</span></span> <span class="au"><a href="/2014">2014</a><span class="ao">(46)</span></span> <span class="au"><a href="/2015">2015</a><span class="ao">(24)</span></span> <span class="au"><a href="/2016">2016</a><span class="ao">(6)</span></span> <span class="au"><a href="/2018">2018</a><span class="ao">(1)</span></span> <span class="au"><a href="/2019">2019</a><span class="ao">(2)</span></span> <span class="au"><a href="/2020">2020</a><span class="ao">(5)</span></span> <span class="au"><a href="/2021">2021</a><span class="ao">(3)</span></span> <span class="au"><a href="/2022">2022</a><span class="ao">(3)</span></span> <span class="au"><a href="/2023">2023</a><span class="ao">(2)</span></span></div></div></div></div></div><div class="y av"><div class="z"><div class="ag"><p>© 2012 - 2025 Johannes Bader, last updated July 31, 2025</p></div></div></div></div></footer></div></div></body></html>