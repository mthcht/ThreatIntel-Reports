<!doctype html><html lang="en-US"><head><link href="/assets/fonts/Montserrat-VariableFont_wght.woff2" rel="preload" type="font/woff2" as="font" crossorigin=""><meta charset="utf-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>The DGA of Zloader</title><meta content="Zloader — also known as Terdot, DELoader or Zeus Sphinx — is a malware from May 2016 that has resurged in the last few weeks. This blog post shows how to reverse engineer the domain generation algorithm of Zloader." name="description" property="og:description"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="en_US" property="og:locale"><meta content="./assets/img/front/zloader-800.jpeg" property="og:image"><meta content="website" property="og:type"><meta content="Binary Reverse Engineering Blog" property="og:site_name"><meta content="The DGA of Zloader" property="og:title"><meta content="summary" name="twitter:card"><meta content="@viql" name="twitter:site"><meta content="@viql" name="twitter:creator"><meta content="The DGA of Zloader" name="twitter:title"><meta content="Zloader — also known as Terdot, DELoader or Zeus Sphinx — is a malware from May 2016 that has resurged in the last few weeks. This blog post shows how to reverse engineer the domain generation algorithm of Zloader." name="twitter:description"><meta content="https://bin.re/assets/img/front/zloader-800.jpeg" name="twitter:image"><link href="/assets/css/common-bb493b.css" rel="stylesheet"><link href="feed.xml" rel="alternate" type="application/atom+xml" title="Atom feed for the Blog"><link href="/assets/css/blog-a83391.css" rel="stylesheet"><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><link href="/apple-touch-icon-192x192.png" rel="apple-touch-icon" sizes="192x192"><link href="/apple-touch-icon-512x512.png" rel="apple-touch-icon" sizes="512x512"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon"><noscript><style>img.lazyload {
          display: none;
        }</style></noscript><script src="/assets/js/all.min-a1c570.js" defer></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="/assets/js/mathjax-local-ec3392.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" crossorigin="anonymous" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0="></script></head><body class="a b7"><div class="b"><div class="d"><div class="f e"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-close" xlink:href="/assets/svg/icons.svg#icon-close"></use></svg></div><div class="h"><ul class="i j sidebar"><li class="q r"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Varia<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul></div></div></div><div id="aw"><div class="w"><header class="y x"><nav class="z a0"><a href="/"><span class="a1"><!-- Generator: Adobe Illustrator 25.0.0, SVG Export Plug-In  --> <svg viewBox="0 0 86.4 20.21" height="20.21px" style="overflow:visible;enable-background:new 0 0 86.4 20.21;" version="1.1" width="86.4px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g><path class="a2" d="M28.56,5.13c-1.99,0-2.87-1.12-2.87-2.57c0-1.5,0.9-2.57,2.87-2.57c2.02,0,2.95,1.07,2.95,2.57
    C31.51,4.01,30.58,5.13,28.56,5.13z M25.96,19.94V6.47h5.22v13.46H25.96z"></path><path class="a2" d="M43.69,19.94v-7.92c0-1.23-0.27-1.91-1.59-1.91c-0.6,0-1.53,0.3-2.24,0.76v9.07H34.6V6.45h4.89l0.08,1.31
    l0.16,0.05c1.58-1.12,3.5-1.69,4.78-1.69c3.47,0,4.42,1.91,4.42,4.86v8.96H43.69z"></path><path class="a2" d="M54.33,20.15c-1.83,0-2.62-1.01-2.62-2.37c0-1.37,0.82-2.35,2.62-2.35c1.86,0,2.68,0.98,2.68,2.35
    C57,19.14,56.16,20.15,54.33,20.15z"></path><path class="a2" d="M65.14,9.23c1.58-1.69,3.85-3.17,5.49-3.17c0.63,0,0.79,0.49,0.79,1.09c0,1.45-0.87,4.29-1.58,5.3l-4.51-0.57
    v8.06h-5.21V6.45h5.16c0,0.66-0.14,2.08-0.25,2.7L65.14,9.23z"></path><path class="a2" d="M86.4,12.78v1.2h-8.63c0.03,1.72,1.07,2.4,3.03,2.4c1.34,0,3-0.35,4.34-0.76l0.98,3.2
    c-1.94,1.04-4.34,1.39-6.25,1.39c-5.9,0-7.32-3.33-7.32-6.99c0-3.41,1.58-7.13,7.07-7.13C85.74,6.09,86.4,9.78,86.4,12.78z
     M77.82,11.52h3.9c-0.03-1.31-0.41-2.29-1.83-2.29C78.4,9.23,77.93,10.32,77.82,11.52z"></path><path class="a2" d="M6.92,12.81"></path><path class="a2" d="M17.24,6.06c-0.79,0-2.43,0.29-3.87,1.3c0-0.14-0.06-2.69-0.06-3.07V0.27H8.12v9.28
    c2.71-0.69,4.54-1.87,5.24-2.18v3.06c-0.85,0.55-4.15,2.11-5.24,2.44v5.86c2.62,1.28,6.12,1.48,7.54,1.48
    c5.79,0,7.16-3.33,7.16-7.02C22.82,9.07,21.45,6.06,17.24,6.06z M15.41,16.6c-0.54,0-1.31-0.08-2.05-0.38v-5.79
    c0.66-0.33,1.45-0.65,2.16-0.65c1.01,0,2.1,0.35,2.1,3.47C17.63,16.14,16.59,16.6,15.41,16.6z"></path><path class="a2" d="M8.12,9.55c-1.03,0.23-2.56,0.51-3.66,0.23l0-3.09L0,11.57l4.51,4.88l0-3.13c1.38,0.17,2.69-0.23,3.61-0.45
    V9.55z"></path></g></svg></span></a><div class="a3"><button class="a2 a4" id="ax"><svg height="20px" version="1.1" width="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewport="0 0 20 20"><path class="a5" d="M2.28,15.89l1.57-1.61l1.24,1.24l-1.57,1.61L2.28,15.89z M8.86,19.33v-2.61h1.74v2.61H8.86z M9.73,4.35
	c1.46,0,2.71,0.52,3.75,1.55s1.55,2.28,1.55,3.75s-0.52,2.71-1.55,3.75c-1.03,1.03-2.28,1.55-3.75,1.55s-2.71-0.52-3.75-1.55
	s-1.55-2.28-1.55-3.75S4.95,6.93,5.98,5.9S8.26,4.35,9.73,4.35z M16.81,8.77h2.65v1.78h-2.65V8.77z M14.36,15.52l1.24-1.2l1.57,1.57
	l-1.24,1.24L14.36,15.52z M17.18,3.43l-1.57,1.57l-1.24-1.24l1.57-1.57L17.18,3.43z M10.6,0v2.61H8.86V0C8.86,0,10.6,0,10.6,0z
	 M2.65,8.77v1.78H0V8.77H2.65z M5.09,3.77L3.85,5.01L2.28,3.43l1.24-1.24L5.09,3.77z"></path><path class="a6" d="M14.18,14.19c3.31-3.31,3.31-8.67,0-11.97C13.06,1.1,11.7,0.36,10.26,0c2.2,2.88,1.98,7.01-0.65,9.65
	C6.99,12.26,2.88,12.49,0,10.33c0.37,1.41,1.1,2.76,2.21,3.87C5.52,17.5,10.88,17.5,14.18,14.19z M7.1,2.48H6.36l0.52,0.52
	L6.55,3.34L6.03,2.81v0.74H5.56V2.81L5.04,3.34L4.71,3.01l0.52-0.52H4.49V2.02h0.74L4.71,1.49l0.33-0.33l0.52,0.52V0.95h0.47v0.74
	l0.52-0.52l0.33,0.33L6.36,2.02H7.1V2.48z M0.94,3.94c0,0.26-0.21,0.47-0.47,0.47S0,4.2,0,3.94s0.21-0.47,0.47-0.47
	S0.94,3.68,0.94,3.94z M3.88,5.66c0,0.29-0.24,0.53-0.53,0.53S2.83,5.95,2.83,5.66c0-0.29,0.24-0.53,0.53-0.53S3.88,5.36,3.88,5.66z
	"></path></svg></button><ul class="i j a7"><li class="q"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Varia<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t r"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul><div class="f a8 a9"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bars" xlink:href="/assets/svg/icons.svg#icon-bars"></use></svg></div></div></nav></header><div class="b8"><noscript>&lt;img src="/assets/img/header/zloader-640.jpeg" class="-minfy-post__title-image"/&gt;</noscript><img alt="cover image for post 'The DGA of Zloader'" class="lazyload b9" data-src="/assets/img/header/zloader-640.jpeg" data-srcset="/assets/img/header/zloader-1080.webp 1080w,
/assets/img/header/zloader-830.webp 830w,
/assets/img/header/zloader-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMjMzIj48cGF0aCBmaWxsPSIjNTQyZDNlIiBkPSJNMCAwaDMwMHYyMzNIMHoiLz48ZyBmaWxsLW9wYWNpdHk9Ii41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNiAuNilzY2FsZSgxLjE3MTg4KSI+PGVsbGlwc2UgY3g9IjEyMSIgY3k9IjE1MCIgcng9IjI1NSIgcnk9IjYzIi8+PGVsbGlwc2UgY3g9IjExMiIgY3k9IjI0IiByeD0iMjU1IiByeT0iMjgiLz48cGF0aCBmaWxsPSIjOWY1MDZlIiBkPSJNMTA3IDUyaDE0OXYzN0gxMDd6Ii8+PHBhdGggZD0iTTE2MSA2MGgyMXYyMWgtMjF6Ii8+PHBhdGggZmlsbD0iI2ZmYTdkZiIgZD0iTTI2IDgyaDI5djdIMjZ6Ii8+PHBhdGggZmlsbD0iIzAwMDAwMiIgZD0iTTI1IDM2aDM4djQ1SDI1eiIvPjxwYXRoIGZpbGw9IiNmZjljY2UiIGQ9Ik0xOCA1MGg3djM5aC03eiIvPjxwYXRoIGQ9Im0yNDIgMTAwLTItMzktMTktM3oiLz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4PSItLjUiIHk9Ii0uNSIgdHJhbnNmb3JtPSJyb3RhdGUoODUgMTUgMTEzLjgpc2NhbGUoMjkgMjApIi8+PHBhdGggZD0iTTE0NCA0NGg4djYxaC04eiIvPjxwYXRoIGZpbGw9IiNkYjZmOTciIGQ9Im05NC41IDY2LjctOSAyNC42TDY3LjkgODRsOTEuMy0xNS4yeiIvPjxwYXRoIGZpbGw9IiNmZmExZDkiIGQ9Ik03MSA1MmgyMXY2SDcxeiIvPjxlbGxpcHNlIGN4PSIxNTUiIGN5PSI2OSIgZmlsbD0iI2ZmOTZjOCIgcng9IjQiIHJ5PSIyMCIvPjxwYXRoIGZpbGw9IiMxNzBkMTYiIGQ9Ik0yNTQuNSAyMTQgMjcxIDQwLjJsLTIzLjEgNDguMkwtMTYgMTkwLjJ6Ii8+PHBhdGggZmlsbD0iI2ZmOTdjYyIgZD0iTTI0MyA1Mmg1djM3aC01eiIvPjxwYXRoIGZpbGw9IiNmZmEwZDciIGQ9Ik02MyA2MGg2djIyaC02eiIvPjxwYXRoIGZpbGw9IiNmZjhlYmIiIGQ9Ik0xOTcgNTFoN3YzOGgtN3oiLz48cGF0aCBmaWxsPSIjMTQwYTEyIiBkPSJNMTIwLjIgMjguMiA5NyAxMDMuN2wxMC43LTExNi45LTk0LjYgNjYuOHoiLz48cGF0aCBkPSJtMTk4IDk0LTEzLTEgMTAtMzl6Ii8+PGVsbGlwc2UgY3g9IjE2OCIgY3k9Ijg1IiBmaWxsPSIjZmY5NWM1IiByeD0iMTQiIHJ5PSI0Ii8+PHBhdGggZD0ibTIwMy41IDgwLjggMTMuOSAxLjMgMjQuNS04LjUtMzIuNCAxeiIvPjxwYXRoIGZpbGw9IiNmZjk0YzAiIGQ9Ik0yMDQgNTJoMjl2N2gtMjl6Ii8+PHBhdGggZmlsbD0iI2ZmODhiNiIgZD0ibTIwNC40IDgzIDI5LTEgLjIgNy0yOSAxeiIvPjxwYXRoIGZpbGw9IiMwNDAwMDMiIGQ9Im0xNy45IDQ3LjQtMS40IDYzLjMtOC0zMS44TC0xNiA4OS4xeiIvPjxwYXRoIGQ9Ik03MCA2MGgyMnYyMUg3MHoiLz48ZWxsaXBzZSBjeD0iMjExIiBjeT0iNzAiIGZpbGw9IiNmZjhlYmEiIHJ4PSIxNSIgcnk9IjQiLz48cGF0aCBmaWxsPSIjZjE3YWFiIiBkPSJtMTg4LjYgNjQuOS0xNS01LjUtMjMuMS0yLjggMjYuNS02LjN6Ii8+PHBhdGggZmlsbD0iI2ZmOTNjNCIgZD0iTTEwOCA1OWg2djMxaC02eiIvPjxwYXRoIGZpbGw9IiNmZjk4YzciIGQ9Im0tMTEuOCA4OCAuNy04IDIyLjkgMi0uNyA4eiIvPjxwYXRoIGZpbGw9IiNmZjk1YzMiIGQ9Ik0xMTYgNTJoMjF2N2gtMjF6Ii8+PC9nPjwvc3ZnPg=="></div><main class="y aa"><article class="z ae ac ba"><div class="bb"><h1 class="bc">The DGA of Zloader</h1></div><div class="bd"><ul class="i be"><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-calendar-o" xlink:href="/assets/svg/icons.svg#icon-calendar-o"></use></svg> <a href="https://bin.re/2020/04">April 26, 2020</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-book" xlink:href="/assets/svg/icons.svg#icon-book"></use></svg> <a href="/category/reverse-engineering">reverse engineering</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-tags" xlink:href="/assets/svg/icons.svg#icon-tags"></use></svg> <span class="bf"><a href="/tag/dga" class="bg">dga</a> <a href="/tag/malware-analysis" class="bg">malware analysis</a> <a href="/tag/zloader" class="bg">zloader</a></span></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-comments-o" xlink:href="/assets/svg/icons.svg#icon-comments-o"></use></svg> no comments</li></ul><div class="bh"><span class="bj">Table of Contents</span><ul class="i bk"><li><a href="#reverse-engineering">Reverse Engineering</a></li><li><a href="#reimplementation-in-python">Reimplementation in Python</a></li><li><a href="#other-samples-other-seeds">Other Samples - Other Seeds</a></li><li><a href="#2169e871d4ca668d1872722d1a0695dc">2169e871d4ca668d1872722d1a0695dc</a></li><li><a href="#fa9b3dfdb4b97dfe0db5991472f89399">fa9b3dfdb4b97dfe0db5991472f89399</a></li><li><a href="#306212efebc6ac92000687393e56a5cb">306212efebc6ac92000687393e56a5cb</a></li></ul><div><span class="bj">Disclaimer<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-exclamation-triangle" xlink:href="/assets/svg/icons.svg#icon-exclamation-triangle"></use></svg></span><p>These are just unpolished notes. The content likely lacks clarity and structure; and the results might not be adequately verified and/or incomplete.</p></div><span class="bj">Aliases</span><p>The malware in this blog post is also known as <span class="bl">Zloader</span>, <span class="bl">Terdot</span>, <span class="bl">DELoader</span> and <span class="bl">Zeus Sphinx</span></p><div><span class="bj">Malpedia</span><p>For more information about the malware in this blog post see the <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.zloader" class="bm">Malpedia entry on Zloader</a>.</p></div><div><span class="bj">URLhaus</span><p><a href="https://urlhaus.abuse.ch/browse/tag/zloader/" class="bm">This page</a> lists malware URLs that are tagged with zloader.</p></div><div><span class="bj">MalwareBazaar</span><p>You can download zloader samples from <a href="https://bazaar.abuse.ch/browse/tag/zloader/" class="bm">this page</a>.</p></div></div></div><div class="b6 bi"><p>Zloader — also known as Terdot, DELoader or Zeus Sphinx <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> — is a malware from May 2016 that has resurged in the last few weeks <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> <sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup> <sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>. The last two references <sup id="fnref1:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup> <sup id="fnref1:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup> are posts by <a href="https://twitter.com/malware_traffic">Brad Duncan</a> that mention and list random domain names:</p><blockquote><p>[…] then it started generating DNS queries for random 20-character alphabetic strings with .com as the top level domain (TLD). I’ve included some examples below.</p></blockquote><pre tabindex="0"><code>jgqhigsjkulmsvvhshmk.com
wapjdxlstholqwakofgi.com
aiavxvlshmkweccksfky.com
liswrfujohqsnbnohetn.com
hciqylualwcnyvajdkqq.com
pdtlshacpbacpnhcndpd.com
kdacggcctwcavdgvpbmk.com
wapwtpwciertrhkdaxrp.com
shyjgiyhyegxeqqpdtya.com
gccggcctwcerlshacpba.com
cpnhcndpdkylibtlbeco.com
bxhwpdkqdakbplfvfqwn.com
bioonshmwrbecckfcavh.com
</code></pre><p>Similar 20-character domains had also been referenced by Twitter User <a href="https://twitter.com/0xE9FBFFFFFF/status/1250052864363450369">TomasP</a>, who apparently also reverse engineered the domain generation algorithm (DGA) <sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>, yet did not publish it. Twitter User <a href="https://twitter.com/DynamicAnalysis">DynamicAnalysis</a> subsequently published DGA domains on Pastebin — for example <sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup> <sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup> — but only for one particular seed.</p><p>This blog post shows how to reverse engineer the algorithm and presents as a result a <a href="#reimplementation-in-python">reimplementation in Python</a>. The post is based on the following sample, but I also looked at <a href="#other-samples---other-seeds">other samples</a> to find additional seeds.</p><dl><dt>MD5</dt><dd>afdf2fbc0756ed304d1a33083a5f2b0f</dd><dt>SHA1</dt><dd>f3a25627f925390097a64a84ef34c952fe8af036</dd><dt>SHA256</dt><dd>a947c216ea52ce23457b3babb1e1eb6275cabe2150d3995553e4de4b8c3d97f4</dd><dt>Size</dt><dd>323 KB (330752 Bytes)</dd><dt>Compile Timestamp</dt><dd>2019-05-27 07:19:22 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/a947c216ea52ce23457b3babb1e1eb6275cabe2150d3995553e4de4b8c3d97f4/">MalwareBazaar</a>, <a href="https://urlhaus.abuse.ch/url/347737/">URLHaus</a>, <a href="https://twitter.com/p5yb34m/status/1252648679543934976">Twitter</a>, <a href="https://www.virustotal.com/gui/file/a947c216ea52ce23457b3babb1e1eb6275cabe2150d3995553e4de4b8c3d97f4">VirusTotal</a></dd><dt>Filenames</dt><dd>antiamsi.bin (MalwareBazaar), antiamsi.bin (VirusTotal)</dd><dt>Detections</dt><dd><strong>MalwareBazaar</strong>: ZLoader, <strong>Virustotal</strong>: 52/74 as of 2020-04-25 03:46:18 - TrojanSpy:Win32/Glupteba.ef0afc48 (Alibaba), Trojan:Win32/Glupteba.RRS!MTB (Microsoft), Win32.Trojan-spy.Zbot.Lscl (Tencent), Trojan-Spy.Win32.Zbot.zzac (ZoneAlarm)</dd></dl><p>The sample is — as is customary — packed. Unpacking it leads to this sample:</p><dl><dt>MD5</dt><dd>c844efe1b7e76cbdea36ce62ff788de9</dd><dt>SHA1</dt><dd>d8143cf09bff7b0ca2a0c777912746a5922104ee</dd><dt>SHA256</dt><dd>835048e00ba3babf6f920c9a4c2863865a5dcf8e0b6ede4f57c63aeb9cb5c147</dd><dt>Size</dt><dd>184 KB (188416 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-04-08 18:19:58 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/835048e00ba3babf6f920c9a4c2863865a5dcf8e0b6ede4f57c63aeb9cb5c147/">MalwareBazaar</a>, <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.zloader">Malpedia</a>, <a href="afdf2fbc0756ed304d1a33083a5f2b0f">Dropped_by_md5</a>, <a href="https://www.virustotal.com/gui/file/835048e00ba3babf6f920c9a4c2863865a5dcf8e0b6ede4f57c63aeb9cb5c147">VirusTotal</a></dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 30/74 as of 2020-04-25 20:55:07 - a variant of Win32/Spy.Zbot.ADI (ESET-NOD32), W32/Zbot.ADI!tr (Fortinet), HEUR:Backdoor.Win32.Dridex.vho (Kaspersky), BehavesLike.Win32.Adopshel.ch (McAfee-GW-Edition), HEUR:Backdoor.Win32.Dridex.vho (ZoneAlarm)</dd></dl><p>This sample creates a new Windows installer process <code>msiexec.exe</code> in suspended state. It then writes an encrypted copy of itself into <code>msiexec.exe</code>, as well as a decryption stub. The thread context is set to the stub and execution of the thread is resumed. The decryption stub decrypts the injected binary and jumps to the first subroutine at offset 0x1C90. I dumped the sample with entry point set to this starting point. It should be “runnable” if loaded with image base <code>0x03090000</code>:</p><dl><dt>MD5</dt><dd>5c76c41f9d0cc939240b3101541b5475</dd><dt>SHA1</dt><dd>da361ec6976d3d9225ce40951b26d1d8ecdb7fd1</dd><dt>SHA256</dt><dd>4029f9fcba1c53d86f2c59f07d5657930bd5ee64cca4c5929cbd3142484e815a</dd><dt>Size</dt><dd>208 KB (212992 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-04-08 18:19:58 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/4029f9fcba1c53d86f2c59f07d5657930bd5ee64cca4c5929cbd3142484e815a/">MalwareBazaar</a>, <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.zloader">Malpedia</a>, <a href="c844efe1b7e76cbdea36ce62ff788de9">Dropped_by_md5</a>, <a href="https://www.virustotal.com/gui/file/4029f9fcba1c53d86f2c59f07d5657930bd5ee64cca4c5929cbd3142484e815a">VirusTotal</a></dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 22/74 as of 2020-04-25 20:55:24 - Win32/Spy.Zbot.ADI (ESET-NOD32), BScope.Trojan-Spy.Zbot (VBA32)</dd></dl><p>The following analysis is based on this last sample (f3f2393a838d417ff8f823a235bd83f2) loaded at image base 0x03091CD2.</p><h2 id="reverse-engineering">Reverse Engineering</h2><p>The analysis of the sample is complicated mainly by three techniques:</p><ol><li>The strings are encrypted. I chose the <a href="https://www.hex-rays.com/wp-content/uploads/2019/12/debugging_appcall.pdf">Appcall</a> functionality of IDA Pro to decrypt them dynamically.</li><li>API calls are hidden by dynamically resolving them using function hashes. Again, Appcalls to evaluate the routine that resolves the API reveal most API names.</li><li>Constant unfolding, dead code insertion and artithmetic substitution via indentities. The first two are mostly removed by the Hex Rays decompiler, and the arithemetic identities can be easily simplified with basic logical equivalences. I’ll show an example of this when analysing the DGA</li></ol><p>Decryption of strings takes one function argument - the offset to the ciphertext:</p><pre tabindex="0"><code>.text:03091CDB 68 B4 CA 0B 03          push    offset dword_30BCAB4
.text:03091CE0 E8 1B 17 01 00          call    decrypt_string  ; BOT-INFO
</code></pre><p>The comment next to the <code>decrypt_string</code> function call with the plaintext was found by running the following IDA script:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">idc</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">idautils</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RESOLVER_TYPE_DEC</span> <span class="o">=</span> <span class="s2">"char *__cdecl decrypt_string(char *a1, char *a2);"</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">"\s([^ (@]+)[(@]"</span><span class="p">,</span> <span class="n">RESOLVER_TYPE_DEC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">RESOLVER_NAME</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resolver_addr</span> <span class="o">=</span> <span class="n">get_name_ea_simple</span><span class="p">(</span><span class="n">RESOLVER_NAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">resolver_addr</span> <span class="o">==</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">RESOLVER_NAME</span> <span class="o">+</span> <span class="s2">" not defined"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resolver</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">Appcall</span><span class="o">.</span><span class="n">typedobj</span><span class="p">(</span><span class="n">RESOLVER_TYPE_DEC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">resolver</span><span class="o">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">resolver_addr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">previous_heads</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">""" iterator to get previous instructions of an address (no including itself) """</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">idc</span><span class="o">.</span><span class="n">is_head</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ea</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ea</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">ea</span><span class="o">+</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ea</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">ea</span> <span class="o">!=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">ea</span>
</span></span><span class="line"><span class="cl">        <span class="n">ea</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">do</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">""" count the nr of references to the resolver function """</span>
</span></span><span class="line"><span class="cl">    <span class="n">xrefs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">CodeRefsTo</span><span class="p">(</span><span class="n">resolver_addr</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="s2">""" iterate over all references """</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xrefs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">"[-] tackling </span><span class="si">{:08X}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">previous_heads</span><span class="p">(</span><span class="n">xr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">empty</span> <span class="o">=</span> <span class="n">Appcall</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span> <span class="o">=</span> <span class="n">resolver</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">"FAILED: appcall failed: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">empty</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">"FAILED: to read back buffer)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">"OK: found </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">set_cmt</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">do</span><span class="p">()</span>
</span></span></code></pre></div><p>Windows API functions such as <em>InternetConnectA</em> are dynamically resolved and then called:</p><pre tabindex="0"><code>.text:030917DC 68 E1 75 E7 0A          push    0AE775E1h
.text:030917E1 6A 13                   push    13h
.text:030917E3 E8 88 19 01 00          call    resolve_api     ; wininet_InternetConnectA
.text:030917E8 83 C4 08                add     esp, 8
.text:030917EB 0F B7 4D 10             movzx   ecx, [ebp+arg_8]
.text:030917EF 6A 00                   push    0
.text:030917F1 6A 00                   push    0
.text:030917F3 6A 03                   push    3
.text:030917F5 6A 00                   push    0
.text:030917F7 6A 00                   push    0
.text:030917F9 51                      push    ecx
.text:030917FA 53                      push    ebx
.text:030917FB 56                      push    esi
.text:030917FC FF D0                   call    eax
</code></pre><p>A similar IDA Pro script as the one to decrypt the strings was used to find the API names and comment the disassembly.</p><p>Listing all references to the string decryption routine, we see one producing the plaintext “<em>.com</em>”:</p><p><noscript>&lt;img src="assets/strings.png" class=""/&gt;</noscript><img alt="List of strings" class="lazyload" data-src="assets/strings.png" data-srcset="assets/strings-1x.webp 796w,
assets/strings-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3OTYiIGhlaWdodD0iNTc5IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 796px) 100vw, 796px"></p><p>Because the strings are deciphered immediatly before they are used, the decryption call for <em>.com</em> leads to the <a href="assets/dga_large.png">DGA routine</a>. IDA Pro does a very good job of decompiling the routine. I renamed a few variables and subroutines to get to this C code:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">the_dga</span><span class="p">(</span><span class="kt">int</span> <span class="n">dwSeed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nNumberOfDomains</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pArrayOfDomains</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// edi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span> <span class="c1">// ebx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">the_letter</span><span class="p">;</span> <span class="c1">// al
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dwSeedXored_1</span><span class="p">;</span> <span class="c1">// ebx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">szTLD_1</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">i_1</span><span class="p">;</span> <span class="c1">// [esp-10h] [ebp-48h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">szTLD</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span> <span class="c1">// [esp+1h] [ebp-37h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_DWORD</span> <span class="n">the_domain_object</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">// [esp+14h] [ebp-24h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dwSeedXored</span><span class="p">;</span> <span class="c1">// [esp+20h] [ebp-18h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">iDomainNr</span><span class="p">;</span> <span class="c1">// [esp+24h] [ebp-14h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">szDomain</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span> <span class="c1">// [esp+2Bh] [ebp-Dh]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">nNumberOfDomains</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">dwSeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dwSeedXored</span> <span class="o">=</span> <span class="n">dwSeed</span> <span class="o">^</span> <span class="mh">0x81716ECC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">iDomainNr</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">initialize</span><span class="p">(</span><span class="n">the_domain_object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="n">r</span> <span class="o">%</span> <span class="n">get_nr_25</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">the_letter</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">get_nr_97</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">dwSeedXored_1</span> <span class="o">=</span> <span class="n">dwSeedXored</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">szDomain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_letter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">update_domain_object</span><span class="p">(</span><span class="n">szDomain</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">dwSeedXored_1</span> <span class="o">^</span> <span class="n">or</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">szDomain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x81716ECC</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">szDomain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x7E8E9133</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">i_1</span> <span class="o">=</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">plus</span><span class="p">(</span><span class="n">i_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">get_nr_20</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">szTLD_1</span> <span class="o">=</span> <span class="n">decrypt_string</span><span class="p">(</span><span class="n">szTLDCiphertext</span><span class="p">,</span> <span class="n">szTLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">concatenate</span><span class="p">(</span><span class="n">szTLD_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">save_in_array</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">pArrayOfDomains</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">the_domain_object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">reset</span><span class="p">(</span><span class="n">the_domain_object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="n">plus_0</span><span class="p">(</span><span class="n">iDomainNr</span> <span class="o">+</span> <span class="mh">0x6A6E645D</span><span class="p">,</span> <span class="mi">1u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x6A6E645D</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">nNumberOfDomains</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The code is already pretty readable. The only non obvious part is the random number calculation — variable <em>r</em> — which requires some basic logical computation. Let the seed <code>dwSeed</code> be <em>s</em>, and <code>szDomain[0]</code> be <em>l</em>, then the next number is determined as follows ($\cdot$, $\oplus$, and $+$ stand for logical and, xor and or respectively):</p><p>$$ \begin{align*} r &amp;= (s \oplus \text{0x81716ECC}) \oplus (\sim (r + l) \cdot \text{0x81716ECC} ) + ((r + l)\cdot \text{0x7E8E9133}) \end{align*} $$</p><p>The two constants have the following relationship:</p><p>$$ 0x81716ECC = \sim 0x7E8E9133 \text{ mod } 2^{32} $$</p><p>Futhermore</p><p>$$ a \oplus b = (\sim a \cdot b) + (a \cdot \sim b) $$</p><p>So by setting <em>k= 0x81716ECC</em> we get:</p><p>$$ \begin{align*} r &amp;= (s \oplus k) \oplus (\sim (r + l) \cdot k ) + ((r + l)\cdot \sim k) \\ &amp;= s \oplus k \oplus ( (r+l) \oplus k) \\ &amp;= s \oplus (r + l) \end{align*} $$</p><p>This leads to the following Python code for the DGA:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dga</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">nr_of_domains</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">domains</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">seed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_of_domains</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">domain</span> <span class="o">=</span> <span class="s2">""</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">letter</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">%</span> <span class="mi">25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">domain</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">^</span> <span class="p">(</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">letter</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">domain</span> <span class="o">+=</span> <span class="s2">".com"</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
</span></span></code></pre></div><p>Looking at the caller of the domain generation routine, we see how the seed is calculated:</p><pre tabindex="0"><code>.text:03095540 push    ebp
.text:03095541 mov     ebp, esp
.text:03095543 push    ebx
.text:03095544 push    edi
.text:03095545 push    esi
.text:03095546 sub     esp, 16Ch
.text:0309554C lea     edi, [ebp+pS]
.text:03095552 mov     [ebp+var_1C], ecx
.text:03095555 push    edi
.text:03095556 call    decrypt_config_rc4
.text:0309555B add     esp, 4
.text:0309555E lea     esi, [ebp+pArrayOfDomains]
.text:03095561 mov     ecx, esi
.text:03095563 call    sub_30BA8E0
.text:03095568 call    get_today_at_0UTC
.text:0309556D mov     [ebp+dwSeed], eax
.text:03095570 call    sub_30A5260
.text:03095575 lea     ecx, [ebp+dwSeed]
.text:03095578 push    edi
.text:03095579 push    eax
.text:0309557A push    ecx
.text:0309557B call    rc4_encrypt
.text:03095580 add     esp, 0Ch
.text:03095583 mov     edi, [ebp+dwSeed]
.text:03095586 call    get_nr_of_domains
.text:0309558B push    esi
.text:0309558C push    eax
.text:0309558D push    edi
.text:0309558E call    the_dga
</code></pre><p>First, the config of Zloader is decrypted with RC4. The RC4 key <code>djluflczrgefphtiwegc</code> is hardcoded in the sample. The config contains the hardcoded domains which are contacted before the DGA domains are used — if at all. At the end of the config, there is a new RC4 key <code>q23Cud3xsNf3</code> which is used for seeding the DGA:</p><pre tabindex="0"><code>s
TelegramCrypt
AntiAMSIdoc
http://wmwifbajxxbcxmucxmlc.com/post.php
http://pwkqhdgytsshkoibaake.com/post.php
http://snnmnkxdhflwgthqismb.com/post.php
http://iawfqecrwohcxnhwtofa.com/post.php
http://nlbmfsyplohyaicmxhum.com/post.php
http://fvqlkgedqjiqgapudkgq.com/post.php
http://cmmxhurildiigqghlryq.com/post.php
http://nmqsmbiabjdnuushksas.com/post.php
http://fyratyubvflktyyjiqgq.com/post.php
q23Cud3xsNf3
</code></pre><p>The seed is based on the unix timestamp for the current date at time 00:00 UTC. This 32bit value is representated in little endian order, and the four bytes are RC4 encrypted with the key from the config, i.e., <code>q23Cud3xsNf3</code>. The result is then interpreted as the little endian representation of the seed. The following Python snippet shows the seeding procedure.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="s2">"q23Cud3xsNf3"</span>
</span></span><span class="line"><span class="cl"><span class="n">rc4</span> <span class="o">=</span> <span class="n">RC4</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">d</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">"&lt;I"</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="n">rc4</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">seed</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">"&lt;I"</span><span class="p">,</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span></code></pre></div><p>With the seeding procedure and the DGA finished, we can now give a complete reimplementation of the DGA.</p><h2 id="reimplementation-in-python">Reimplementation in Python</h2><p>The following Python code can be used to generate the Zloader domains for any date and RC4 seed value. For example, to generate the domains for April 25, 2020 and seed <code>q23Cud3xsNf3</code> do <code>dga.py -d 2020-04-25 --rc4 q23Cud3xsNf3</code>. You also find the algorithm in my <a href="https://github.com/baderj/domain_generation_algorithms/tree/master/zloader">domain generation GitHub repository</a>.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RC4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key_s</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">S</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">            <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">S</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">prng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">K</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="n">d</span> <span class="o">^</span> <span class="bp">self</span><span class="o">.</span><span class="n">prng</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="s2">""</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">seeding</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc4</span> <span class="o">=</span> <span class="n">RC4</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">d</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">"&lt;I"</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">rc4</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">"&lt;I"</span><span class="p">,</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dga</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">nr_of_domains</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_of_domains</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">domain</span> <span class="o">=</span> <span class="s2">""</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">letter</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">%</span> <span class="mi">25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">domain</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">^</span> <span class="p">((</span><span class="n">r</span> <span class="o">+</span> <span class="n">letter</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">domain</span> <span class="o">+=</span> <span class="s2">".com"</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-d"</span><span class="p">,</span> <span class="s2">"--date"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"date when domains are generated"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-r"</span><span class="p">,</span> <span class="s2">"--rc4"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">help</span><span class="o">=</span><span class="s2">"rc4 key from config"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">"q23Cud3xsNf3"</span><span class="p">,</span><span class="s2">"41997b4a729e1a0175208305170752dd"</span><span class="p">,</span> <span class="s2">"kZieCw23gffpe43Sd"</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">default</span><span class="o">=</span><span class="s2">"q23Cud3xsNf3"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span> <span class="o">=</span> <span class="n">seeding</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">rc4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dga</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="other-samples---other-seeds">Other Samples - Other Seeds</h2><p>For reference, this section lists three more samples that I have analyzed and which have resulted in two additional seeds. You find precalculated lists of the DGA domains for all three seeds in my domain generation GitHub repository <sup id="fnref:10"><a href="#fn:10" class="footnote-ref" role="doc-noteref">10</a></sup>.</p><table><thead><tr><th>md5</th><th>seed</th><th>list of domains</th></tr></thead><tbody><tr><td>afdf2fbc0756ed304d1a33083a5f2b0f</td><td>q23Cud3xsNf3</td><td><a href="https://github.com/baderj/domain_generation_algorithms/blob/master/zloader/domains_q23Cud3xsNf3.txt">list</a></td></tr><tr><td>2169e871d4ca668d1872722d1a0695dc</td><td>q23Cud3xsNf3</td><td><a href="https://github.com/baderj/domain_generation_algorithms/blob/master/zloader/domains_q23Cud3xsNf3.txt">list</a></td></tr><tr><td>fa9b3dfdb4b97dfe0db5991472f89399</td><td>41997b4a729e1a0175208305170752dd</td><td><a href="https://github.com/baderj/domain_generation_algorithms/blob/master/zloader/domains_41997b4a729e1a0175208305170752dd.txt">list</a></td></tr><tr><td>306212efebc6ac92000687393e56a5cb</td><td>kZieCw23gffpe43Sd</td><td><a href="https://github.com/baderj/domain_generation_algorithms/blob/master/zloader/domains_kZieCw23gffpe43Sd.txt">list</a></td></tr></tbody></table><h3 id="2169e871d4ca668d1872722d1a0695dc">2169e871d4ca668d1872722d1a0695dc</h3><dl><dt>MD5</dt><dd>2169e871d4ca668d1872722d1a0695dc</dd><dt>SHA1</dt><dd>add2bbbac042c328ed71c9fd2efcb9cbce5a89f7</dd><dt>SHA256</dt><dd>cc87e6581ca91f941f65332b2de0e681d58491b54aff9d0b30afae828a5f5790</dd><dt>Size</dt><dd>539 KB (552448 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-04-14 11:20:46 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/cc87e6581ca91f941f65332b2de0e681d58491b54aff9d0b30afae828a5f5790/">MalwareBazaar</a>, <a href="https://urlhaus.abuse.ch/url/340197/">URLhaus</a>, <a href="https://www.virustotal.com/gui/file/cc87e6581ca91f941f65332b2de0e681d58491b54aff9d0b30afae828a5f5790">VirusTotal</a></dd><dt>Filenames</dt><dd>SecuriteInfo.com.Win32.GenKryptik.EILT.4491 (MalwareBazaar), output.155861665.txt, Thusput, Thusput.DLL, znvmzdd.dll, ZnVmZdD.dll, april14.dll (VirusTotal)</dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 42/75 as of 2020-04-18 16:11:27</dd></dl><p>unpacks to</p><dl><dt>MD5</dt><dd>6a900d6f8af3a1a0e31ca5bb63637d03</dd><dt>SHA1</dt><dd>221ab3d8ab16a0a7790026aab9b26904be6db436</dd><dt>SHA256</dt><dd>e4d0a79d2463c5d3a71874e3389fa753f480b96639ad32baf1997baf8e5f714a</dd><dt>Size</dt><dd>187 KB (191488 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-04-08 18:20:42 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/e4d0a79d2463c5d3a71874e3389fa753f480b96639ad32baf1997baf8e5f714a/">MalwareBazaar</a>, <a href="https://malpedia.cad.fkie.fraunhofer.de/details/win.zloader">Malpedia</a>, <a href="2169e871d4ca668d1872722d1a0695dc">Dropped_by_md5</a>, <a href="https://www.virustotal.com/gui/file/e4d0a79d2463c5d3a71874e3389fa753f480b96639ad32baf1997baf8e5f714a">VirusTotal</a></dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 29/75 as of 2020-04-25 20:58:26</dd></dl><p>The config is encrypted with RC4 key <code>edykepkrqahpyxabcwgm</code>. These are the hardcoded domains:</p><pre tabindex="0"><code>http://wmwifbajxxbcxmucxmlc.com/post.php
http://ojnxjgfjlftfkkuxxiqd.com/post.php
http://pwkqhdgytsshkoibaake.com/post.php
http://snnmnkxdhflwgthqismb.com/post.php
http://iawfqecrwohcxnhwtofa.com/post.php
http://nlbmfsyplohyaicmxhum.com/post.php
http://fvqlkgedqjiqgapudkgq.com/post.php
http://cmmxhurildiigqghlryq.com/post.php
http://nmqsmbiabjdnuushksas.com/post.php
http://fyratyubvflktyyjiqgq.com/post.php
</code></pre><p>The RC4 key for the DGA seed is <code>q23Cud3xsNf3</code>.</p><h3 id="fa9b3dfdb4b97dfe0db5991472f89399">fa9b3dfdb4b97dfe0db5991472f89399</h3><dl><dt>MD5</dt><dd>fa9b3dfdb4b97dfe0db5991472f89399</dd><dt>SHA1</dt><dd>5677f26e926c8c8d7f7bf7eb085a9e48549a268b</dd><dt>SHA256</dt><dd>3648fe001994cb9c0a6b510213c268a6bd4761a3a99f3abb2738bf84f06d11cf</dd><dt>Size</dt><dd>512 KB (524288 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-04-20 10:48:16 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/3648fe001994cb9c0a6b510213c268a6bd4761a3a99f3abb2738bf84f06d11cf/">MalwareBazaar</a>, <a href="https://urlhaus.abuse.ch/url/346908/">URLHaus</a>, <a href="https://twitter.com/DynamicAnalysis/status/1252259631042301957">Twitter</a>, <a href="https://www.virustotal.com/gui/file/3648fe001994cb9c0a6b510213c268a6bd4761a3a99f3abb2738bf84f06d11cf">VirusTotal</a></dd><dt>Filenames</dt><dd>f.dll (MalwareBazaar), Letter ease, Letter ease.DLL, f.dll (VirusTotal)</dd><dt>Detections</dt><dd><strong>MalwareBazaar</strong>: ZLoader, <strong>Virustotal</strong>: 50/75 as of 2020-04-24 02:51:48</dd></dl><p>unpacks to</p><dl><dt>MD5</dt><dd>133b1861b3590bf00308509227f82872</dd><dt>SHA1</dt><dd>eb6f12759da7aa84077143e3e2694b6fda3d5631</dd><dt>SHA256</dt><dd>dd11381223ab1902db2963df4cbe3299e42064a5857545560f913647c1f70c5a</dd><dt>Size</dt><dd>187 KB (191488 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-04-08 18:20:42 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/dd11381223ab1902db2963df4cbe3299e42064a5857545560f913647c1f70c5a/">MalwareBazaar</a>, <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.zloader">Malpedia</a>, <a href="fa9b3dfdb4b97dfe0db5991472f89399">Dropped_by_md5</a>, <a href="https://www.virustotal.com/gui/file/dd11381223ab1902db2963df4cbe3299e42064a5857545560f913647c1f70c5a">VirusTotal</a></dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 29/74 as of 2020-04-25 21:00:11</dd></dl><p>The config is encrypted with RC4 key <code>dqhfltvppmucpvebkqtn</code>. These are the hardcoded domains:</p><pre tabindex="0"><code>https://dcaiqjgnbt.icu/wp-config.php
https://nmttxggtb.press/wp-config.php
</code></pre><p>The RC4 key for the DGA seed is <code>41997b4a729e1a0175208305170752dd</code>.</p><h3 id="306212efebc6ac92000687393e56a5cb">306212efebc6ac92000687393e56a5cb</h3><dl><dt>MD5</dt><dd>306212efebc6ac92000687393e56a5cb</dd><dt>SHA1</dt><dd>dc0b678e9ad7cadd5de907bf80fa351d5d3347cc</dd><dt>SHA256</dt><dd>8d5a770975e52ce1048534372207336f6cc657b43887daa49994e63e8d7f6ce1</dd><dt>Size</dt><dd>856 KB (877056 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-04-05 16:19:02 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/8d5a770975e52ce1048534372207336f6cc657b43887daa49994e63e8d7f6ce1/">MalwareBazaar</a>, <a href="https://www.virustotal.com/gui/file/8d5a770975e52ce1048534372207336f6cc657b43887daa49994e63e8d7f6ce1">VirusTotal</a></dd><dt>Filenames</dt><dd>JtVhjtbGMAbrWft.dll (MalwareBazaar), FfIYXQPKpCQymHQ.exe, PkRWAytIAsEHwhy.exe, qKMCMByhJjQpfmZ.exe, FmgJjYLZmscJaur.exe, gGwBVwnpxkyFNlc.exe, ZhbIdJYZzrkPQGs.exe, eIGmAdVpMFJxmrk.exe, VUCJyZshHrMGvdT.exe, WHFQhvaOzqkkTFk.exe, dFVlQGPNqrdhrCE.exe, tnXoUCMnjELKOYm.exe, dTEAUJnMdnADEVG.exe, omih.dll, ikhaapd.dll, 2020-04-07-ZLoader-DLL-binary.bin, etidwuv.dll, ekydn.dll, upiqwoq.dll, ryubn.dll, JtVhjtbGMAbrWft.exe, icobyg.dll, GnbjtDwFOsvocUW.exe, CbxfejTbfqXuuIT.exe, JtVhjtbGMAbrWft.bin (VirusTotal)</dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 58/75 as of 2020-04-20 00:40:47</dd></dl><p>unpacks to</p><dl><dt>MD5</dt><dd>4a74e2d34230bbc705f39e6943c859d3</dd><dt>SHA1</dt><dd>410c1c03a52dbd56e78b0487ec532e68eb1c64e4</dd><dt>SHA256</dt><dd>60544c6694620488b69e568b15c96b33971dd7343ba63da31f993332852871c2</dd><dt>Size</dt><dd>172 KB (176640 Bytes)</dd><dt>Compile Timestamp</dt><dd>2020-03-30 18:35:43 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/60544c6694620488b69e568b15c96b33971dd7343ba63da31f993332852871c2/">MalwareBazaar</a>, <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.zloader">Malpedia</a>, <a href="306212efebc6ac92000687393e56a5cb">Dropped_by_md5</a>, <a href="https://www.virustotal.com/gui/file/60544c6694620488b69e568b15c96b33971dd7343ba63da31f993332852871c2">VirusTotal</a></dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 34/75 as of 2020-04-25 20:59:59</dd></dl><p>The config is encrypted with RC4 key <code>cbstobypqnbsnnpehdtb</code>. These are the hardcoded domains:</p><pre tabindex="0"><code>https://knalc.com/sound.php
https://namilh.com/sound.php
https://ronswank.com/sound.php
https://stagolk.com/sound.php
https://mioniough.com/sound.php
https://ergensu.com/sound.php
</code></pre><p>The RC4 key for the DGA seed is <code>kZieCw23gffpe43Sd</code>.</p><div class="footnotes" role="doc-endnotes"><hr><ol><li id="fn:1"><p><a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.zloader">Zloader on Malpedia</a>&nbsp;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:2"><p><a href="https://urlhaus.abuse.ch/browse/tag/zloader/">Zloader downloads on URLHaus</a>&nbsp;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:3"><p><a href="https://threatpost.com/zeus-sphinx-banking-trojan-covid-19/154274/">Threatpost - Zeus Sphinx Banking Trojan Arises Amid COVID-19</a>&nbsp;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:4"><p><a href="https://securityintelligence.com/posts/zeus-sphinx-trojan-awakens-amidst-coronavirus-spam-frenzy/">Security Intelligence - Zeus Sphinx Trojan Awakens Amidst Coronavirus Spam Frenzy</a>&nbsp;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:5"><p><a href="https://www.malware-traffic-analysis.net/2020/04/07/index.html">Malware-Traffic-Analysis.net - A2020-04-07 - PCAP AND MALWARE FOR AN ISC DIARY (ZLOADER)</a>&nbsp;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">↩︎</a>&nbsp;<a href="#fnref1:5" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:6"><p><a href="https://isc.sans.edu/forums/diary/German+malspam+pushes+ZLoader+malware/25996/">SANS ISC Diary - German malspam pushes ZLoader malware</a>&nbsp;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">↩︎</a>&nbsp;<a href="#fnref1:6" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:7"><p><a href="https://twitter.com/0xE9FBFFFFFF/status/1250052864363450369">Tweet by TomasP mentioning the DGA</a>&nbsp;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:8"><p><a href="https://pastebin.com/iRHL4GWi">Zloader domains of seed 41997b4a729e1a0175208305170752dd for 2020-04-20</a>&nbsp;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:9"><p><a href="https://pastebin.com/FMEMAUbb">Zloader domains of seed 41997b4a729e1a0175208305170752dd for 2020-04-14</a>&nbsp;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:10"><p><a href="https://github.com/baderj/domain_generation_algorithms">Github repository</a>&nbsp;<a href="#fnref:10" class="footnote-backref" role="doc-backlink">↩︎</a></p></li></ol></div></div></article></main><footer><div><div class="y"><div class="z ae aj"><div class="ag ak al am"><h3>Links</h3><ul class="i an"><li><a href="http://www.twitter.com/viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-twitter" xlink:href="/assets/svg/icons.svg#icon-twitter"></use></svg> Twitter</a></li><li><a href="http://www.github.com/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-github" xlink:href="/assets/svg/icons.svg#icon-github"></use></svg> GitHub</a></li><li><a href="mailto:hello@bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-envelope-o" xlink:href="/assets/svg/icons.svg#icon-envelope-o"></use></svg> Mail</a></li><li><a href="https://keybase.io/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-keybase" xlink:href="/assets/svg/icons.svg#icon-keybase"></use></svg> Keybase</a></li><li><a href="/feed.xml" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-feed" xlink:href="/assets/svg/icons.svg#icon-feed"></use></svg> RSS</a></li><li><a href="https://threatcat.ch" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-threatcat" xlink:href="/assets/svg/icons.svg#icon-threatcat"></use></svg> Threatcat.ch</a></li><li><a href="https://infosec.exchange/@viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-mastodon" xlink:href="/assets/svg/icons.svg#icon-mastodon"></use></svg> Mastodon</a></li><li><a href="https://bsky.app/profile/viql.bsky.social" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bluesky" xlink:href="/assets/svg/icons.svg#icon-bluesky"></use></svg> Bluesky</a></li></ul></div><div class="ag ak al am"><div><h3>Categories</h3><ul class="i"><li><a href="/category/reverse-engineering">reverse-engineering</a> <span class="ao">(81)</span></li><li><a href="/category/tutorial">tutorial</a> <span class="ao">(14)</span></li><li><a href="/category/project-euler">project-euler</a> <span class="ao">(13)</span></li><li><a href="/category/misc">misc</a> <span class="ao">(2)</span></li><li><a href="/category/visualization">visualization</a> <span class="ao">(2)</span></li></ul></div></div><div class="ag ak al am a7"><div><h3>Tags</h3><span class="ap"><a href="/tag/malware-analysis" class="aq">malware-analysis <span class="ao">(42)</span></a><a href="/tag/dga" class="aq">dga <span class="ao">(36)</span></a><a href="/tag/crackmes" class="aq">crackmes <span class="ao">(23)</span></a><a href="/tag/practical-reverse-engineering" class="aq">practical-reverse-engineering <span class="ao">(16)</span></a><a href="/tag/math" class="aq">math <span class="ao">(15)</span></a><a href="/tag/project-euler" class="aq">project-euler <span class="ao">(13)</span></a><a href="/tag/python" class="aq">python <span class="ao">(12)</span></a><a href="/tag/upatre" class="aq">upatre <span class="ao">(4)</span></a><a href="/tag/visualization" class="aq">visualization <span class="ao">(4)</span></a><a href="/tag/d3js" class="aq">d3js <span class="ao">(3)</span></a></span> <a href="/tag/" class="ar">show all</a></div></div><div class="ag ak al am as"><div class="at"><div><h3>Blog Archive</h3><span class="au"><a href="/2013">2013</a><span class="ao">(20)</span></span> <span class="au"><a href="/2014">2014</a><span class="ao">(46)</span></span> <span class="au"><a href="/2015">2015</a><span class="ao">(24)</span></span> <span class="au"><a href="/2016">2016</a><span class="ao">(6)</span></span> <span class="au"><a href="/2018">2018</a><span class="ao">(1)</span></span> <span class="au"><a href="/2019">2019</a><span class="ao">(2)</span></span> <span class="au"><a href="/2020">2020</a><span class="ao">(5)</span></span> <span class="au"><a href="/2021">2021</a><span class="ao">(3)</span></span> <span class="au"><a href="/2022">2022</a><span class="ao">(3)</span></span> <span class="au"><a href="/2023">2023</a><span class="ao">(2)</span></span></div></div></div></div></div><div class="y av"><div class="z"><div class="ag"><p>© 2012 - 2025 Johannes Bader, last updated July 31, 2025</p></div></div></div></div></footer></div></div></body></html>