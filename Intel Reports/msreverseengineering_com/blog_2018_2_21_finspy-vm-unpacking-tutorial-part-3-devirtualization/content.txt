<!doctype html>
<html xmlns:og="http://opengraphprotocol.org/schema/" xmlns:fb="http://www.facebook.com/2008/fbml" lang="en-US" >

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
  <meta name="viewport" content="initial-scale=1">
  
  <!-- This is Squarespace. --><!-- rolf-rolles-bq5a -->
<base href="">
<meta charset="utf-8" />
<title>FinSpy VM Unpacking Tutorial Part 3: Devirtualization &mdash; Möbius Strip Reverse Engineering</title>
<meta http-equiv="Accept-CH" content="Sec-CH-UA-Platform-Version, Sec-CH-UA-Model" /><link rel="icon" type="image/x-icon" href="https://assets.squarespace.com/universal/default-favicon.ico"/>
<link rel="canonical" href="https://www.msreverseengineering.com/blog/2018/2/21/finspy-vm-unpacking-tutorial-part-3-devirtualization"/>
<meta property="og:site_name" content="Möbius Strip Reverse Engineering"/>
<meta property="og:title" content="FinSpy VM Unpacking Tutorial Part 3: Devirtualization &mdash; Möbius Strip Reverse Engineering"/>
<meta property="og:latitude" content="40.7207559"/>
<meta property="og:longitude" content="-74.00076130000002"/>
<meta property="og:locality" content=""/>
<meta property="og:url" content="https://www.msreverseengineering.com/blog/2018/2/21/finspy-vm-unpacking-tutorial-part-3-devirtualization"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="1. Overview  This is the third and final part in my series on statically unpacking the FinSpy VM. After having deobfuscated the x86 implementation of FinSpy in  part one &amp;nbsp;and after having analyzed the VM and written a disassembler for the bytecode format for the particular sample in questio"/>
<meta itemprop="name" content="FinSpy VM Unpacking Tutorial Part 3: Devirtualization — Möbius Strip Reverse Engineering"/>
<meta itemprop="url" content="https://www.msreverseengineering.com/blog/2018/2/21/finspy-vm-unpacking-tutorial-part-3-devirtualization"/>
<meta itemprop="description" content="1. Overview  This is the third and final part in my series on statically unpacking the FinSpy VM. After having deobfuscated the x86 implementation of FinSpy in  part one &amp;nbsp;and after having analyzed the VM and written a disassembler for the bytecode format for the particular sample in questio"/>
<meta itemprop="author" content="Rolf Rolles"/>
<meta itemprop="datePublished" content="2018-02-21T13:14:59-0800"/>
<meta itemprop="dateModified" content="2018-03-02T12:46:48-0800"/>
<meta itemprop="headline" content="FinSpy VM Unpacking Tutorial Part 3: Devirtualization"/>
<meta itemprop="publisher" content="Möbius Strip Reverse Engineering"/>
<meta name="twitter:title" content="FinSpy VM Unpacking Tutorial Part 3: Devirtualization — Möbius Strip Reverse Engineering"/>
<meta name="twitter:url" content="https://www.msreverseengineering.com/blog/2018/2/21/finspy-vm-unpacking-tutorial-part-3-devirtualization"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:description" content="1. Overview  This is the third and final part in my series on statically unpacking the FinSpy VM. After having deobfuscated the x86 implementation of FinSpy in  part one &amp;nbsp;and after having analyzed the VM and written a disassembler for the bytecode format for the particular sample in questio"/>
<meta name="description" content="" />
<link rel="preconnect" href="https://images.squarespace-cdn.com">
<link rel="preconnect" href="https://use.typekit.net" crossorigin>
<link rel="preconnect" href="https://p.typekit.net" crossorigin>
<script type="text/javascript" src="//use.typekit.net/ik/5WVm_KtEW5xuGFOxRM_pHbt0ouhorTX8IpdCwOAZF-bfezCgfFHN4UJLFRbh52jhWD9DjQjXjhwkZQsKwewhwhZRF2BywDwkwgToiaiaOcuDScmhZW4DZAm0Zh80ZAmk-Ao1OcFzdPUlSa48icmkShm8dciTdcm8Sc80ZkoRdhXCScNCZKukdhUCZWwlj1IujPoDSWmyScmDSeBRZPoRdhXCHKokdhUcOW4zdeU8SkuKSQmyO1FUiABkZWF3jAF8OcFzdPJwSY4zpe8ljPu0daZyH6qJtKGbMg62JMJ7fbKzMsMMeMb6MKG4fHXgIMMjgKMfH6qJK3IbMg6YJMJ7fbRRHyMMeMX6MKG4fHtgIMMjIfMfH6qJRMIbMg6sJMJ.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Varela+Round:ital,wght@0,400"><script type="text/javascript" crossorigin="anonymous" nomodule="nomodule" src="//assets.squarespace.com/@sqs/polyfiller/1.6/legacy.js"></script>
<script type="text/javascript" crossorigin="anonymous" src="//assets.squarespace.com/@sqs/polyfiller/1.6/modern.js"></script>
<script type="text/javascript">SQUARESPACE_ROLLUPS = {};</script>
<script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/extract-css-runtime-fac7c51b9453742e-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-extract_css_runtime');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/extract-css-runtime-fac7c51b9453742e-min.en-US.js" ></script><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/extract-css-moment-js-vendor-b60fc53b12f6d6c5-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-extract_css_moment_js_vendor');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/extract-css-moment-js-vendor-b60fc53b12f6d6c5-min.en-US.js" ></script><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/cldr-resource-pack-b53797d6b38b8c61-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-cldr_resource_pack');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/cldr-resource-pack-b53797d6b38b8c61-min.en-US.js" ></script><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/common-vendors-stable-51880dc0d7a0158c-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-common_vendors_stable');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/common-vendors-stable-51880dc0d7a0158c-min.en-US.js" ></script><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/common-vendors-25a6a9f67fbc7995-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-common_vendors');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/common-vendors-25a6a9f67fbc7995-min.en-US.js" ></script><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/common-3fedaa9076917556-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-common');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/common-3fedaa9076917556-min.en-US.js" ></script><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/commerce-4daa8f0e30dcba1b-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-commerce');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/commerce-4daa8f0e30dcba1b-min.en-US.js" ></script><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].css = ["//assets.squarespace.com/universal/styles-compressed/commerce-9623d3d351c90321-min.en-US.css"]; })(SQUARESPACE_ROLLUPS, 'squarespace-commerce');</script>
<link rel="stylesheet" type="text/css" href="//assets.squarespace.com/universal/styles-compressed/commerce-9623d3d351c90321-min.en-US.css"><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/user-account-core-f3e3238a98853970-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-user_account_core');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/user-account-core-f3e3238a98853970-min.en-US.js" ></script><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].css = ["//assets.squarespace.com/universal/styles-compressed/user-account-core-32dec2abb821f895-min.en-US.css"]; })(SQUARESPACE_ROLLUPS, 'squarespace-user_account_core');</script>
<link rel="stylesheet" type="text/css" href="//assets.squarespace.com/universal/styles-compressed/user-account-core-32dec2abb821f895-min.en-US.css"><script>(function(rollups, name) { if (!rollups[name]) { rollups[name] = {}; } rollups[name].js = ["//assets.squarespace.com/universal/scripts-compressed/performance-641ed7033c6b0b5a-min.en-US.js"]; })(SQUARESPACE_ROLLUPS, 'squarespace-performance');</script>
<script crossorigin="anonymous" src="//assets.squarespace.com/universal/scripts-compressed/performance-641ed7033c6b0b5a-min.en-US.js" defer ></script><script data-name="static-context">Static = window.Static || {}; Static.SQUARESPACE_CONTEXT = {"betaFeatureFlags":["contacts_and_campaigns_redesign","campaigns_discount_section_in_automations","campaigns_new_image_layout_picker","campaigns_thumbnail_layout","marketing_automations","campaigns_import_discounts","campaigns_discount_section_in_blasts","order_status_page_checkout_landing_enabled","i18n_beta_website_locales","marketing_landing_page"],"facebookAppId":"314192535267336","facebookApiVersion":"v6.0","rollups":{"squarespace-announcement-bar":{"js":"//assets.squarespace.com/universal/scripts-compressed/announcement-bar-da53f22272c0f60d-min.en-US.js"},"squarespace-audio-player":{"css":"//assets.squarespace.com/universal/styles-compressed/audio-player-5d864aadea1060d1-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/audio-player-e72461374205e066-min.en-US.js"},"squarespace-blog-collection-list":{"css":"//assets.squarespace.com/universal/styles-compressed/blog-collection-list-b4046463b72f34e2-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/blog-collection-list-47a224f34e715983-min.en-US.js"},"squarespace-calendar-block-renderer":{"css":"//assets.squarespace.com/universal/styles-compressed/calendar-block-renderer-b72d08ba4421f5a0-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/calendar-block-renderer-54badd2a3c7a1ca8-min.en-US.js"},"squarespace-chartjs-helpers":{"css":"//assets.squarespace.com/universal/styles-compressed/chartjs-helpers-96b256171ee039c1-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/chartjs-helpers-ea68dbda5f388989-min.en-US.js"},"squarespace-comments":{"css":"//assets.squarespace.com/universal/styles-compressed/comments-01eecf660cca1c8d-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/comments-7b8bd6df03e1d0fd-min.en-US.js"},"squarespace-custom-css-popup":{"css":"//assets.squarespace.com/universal/styles-compressed/custom-css-popup-01f4ea53f1ef2e01-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/custom-css-popup-8bc9d49de38206f2-min.en-US.js"},"squarespace-dialog":{"css":"//assets.squarespace.com/universal/styles-compressed/dialog-f9093f2d526b94df-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/dialog-af02b70bd295f0f8-min.en-US.js"},"squarespace-events-collection":{"css":"//assets.squarespace.com/universal/styles-compressed/events-collection-b72d08ba4421f5a0-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/events-collection-d6b0fafb2db5f0f2-min.en-US.js"},"squarespace-form-rendering-utils":{"js":"//assets.squarespace.com/universal/scripts-compressed/form-rendering-utils-83f8a5cb99f0d982-min.en-US.js"},"squarespace-forms":{"css":"//assets.squarespace.com/universal/styles-compressed/forms-0afd3c6ac30bbab1-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/forms-26761529c74e14c4-min.en-US.js"},"squarespace-gallery-collection-list":{"css":"//assets.squarespace.com/universal/styles-compressed/gallery-collection-list-b4046463b72f34e2-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/gallery-collection-list-de0dea92b161a99b-min.en-US.js"},"squarespace-image-zoom":{"css":"//assets.squarespace.com/universal/styles-compressed/image-zoom-b4046463b72f34e2-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/image-zoom-104246dd5ee81f93-min.en-US.js"},"squarespace-pinterest":{"css":"//assets.squarespace.com/universal/styles-compressed/pinterest-b4046463b72f34e2-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/pinterest-999ae888ced44ad2-min.en-US.js"},"squarespace-popup-overlay":{"css":"//assets.squarespace.com/universal/styles-compressed/popup-overlay-b742b752f5880972-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/popup-overlay-eb97a22a748d7326-min.en-US.js"},"squarespace-product-quick-view":{"css":"//assets.squarespace.com/universal/styles-compressed/product-quick-view-0ba5bac716923b8e-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/product-quick-view-63d71ad5d1438e3c-min.en-US.js"},"squarespace-products-collection-item-v2":{"css":"//assets.squarespace.com/universal/styles-compressed/products-collection-item-v2-b4046463b72f34e2-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/products-collection-item-v2-d1bdb2ab433d5058-min.en-US.js"},"squarespace-products-collection-list-v2":{"css":"//assets.squarespace.com/universal/styles-compressed/products-collection-list-v2-b4046463b72f34e2-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/products-collection-list-v2-6676ab1a86064e26-min.en-US.js"},"squarespace-search-page":{"css":"//assets.squarespace.com/universal/styles-compressed/search-page-90a67fc09b9b32c6-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/search-page-a1ac365b6124a586-min.en-US.js"},"squarespace-search-preview":{"js":"//assets.squarespace.com/universal/scripts-compressed/search-preview-28c3804d6764d558-min.en-US.js"},"squarespace-simple-liking":{"css":"//assets.squarespace.com/universal/styles-compressed/simple-liking-701bf8bbc05ec6aa-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/simple-liking-b76ae7bcbecc9533-min.en-US.js"},"squarespace-social-buttons":{"css":"//assets.squarespace.com/universal/styles-compressed/social-buttons-95032e5fa98e47a5-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/social-buttons-44a9624f2158f353-min.en-US.js"},"squarespace-tourdates":{"css":"//assets.squarespace.com/universal/styles-compressed/tourdates-b4046463b72f34e2-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/tourdates-a7865865735d59fc-min.en-US.js"},"squarespace-website-overlays-manager":{"css":"//assets.squarespace.com/universal/styles-compressed/website-overlays-manager-07ea5a4e004e6710-min.en-US.css","js":"//assets.squarespace.com/universal/scripts-compressed/website-overlays-manager-1b83c634e75bffd0-min.en-US.js"}},"pageType":50,"website":{"id":"53a64cc2e4b0c63fc41a3320","identifier":"rolf-rolles-bq5a","websiteType":4,"contentModifiedOn":1724352448217,"cloneable":false,"hasBeenCloneable":false,"siteStatus":{},"language":"en-US","timeZone":"America/Los_Angeles","machineTimeZoneOffset":-25200000,"timeZoneOffset":-25200000,"timeZoneAbbr":"PDT","siteTitle":"M\u00F6bius Strip Reverse Engineering","fullSiteTitle":"FinSpy VM Unpacking Tutorial Part 3: Devirtualization \u2014 M\u00F6bius Strip Reverse Engineering","siteTagLine":"Reverse Engineering Training and Consulting Services","siteDescription":"","location":{"mapZoom":12.0,"mapLat":40.7207559,"mapLng":-74.0007613},"shareButtonOptions":{"8":true,"7":true,"1":true,"3":true,"2":true,"4":true,"6":true},"authenticUrl":"https://www.msreverseengineering.com","internalUrl":"https://rolf-rolles-bq5a.squarespace.com","baseUrl":"https://www.msreverseengineering.com","primaryDomain":"www.msreverseengineering.com","sslSetting":3,"isHstsEnabled":true,"typekitId":"","statsMigrated":false,"imageMetadataProcessingEnabled":false,"screenshotId":"1ab975037ccdff31fa158700002d4efcc43a3cb077534d7f9217074e3e2f3d24","showOwnerLogin":false},"websiteSettings":{"id":"53a64cc2e4b0c63fc41a3321","websiteId":"53a64cc2e4b0c63fc41a3320","type":"Business","subjects":[{"systemSubject":"tech"}],"country":"US","state":"CA","simpleLikingEnabled":true,"mobileInfoBarSettings":{"isContactEmailEnabled":false,"isContactPhoneNumberEnabled":false,"isLocationEnabled":false,"isBusinessHoursEnabled":false},"commentLikesAllowed":true,"commentAnonAllowed":true,"commentThreaded":true,"commentApprovalRequired":false,"commentAvatarsOn":true,"commentSortType":2,"commentFlagThreshold":0,"commentFlagsAllowed":true,"commentEnableByDefault":true,"commentDisableAfterDaysDefault":0,"disqusShortname":"","commentsEnabled":true,"contactPhoneNumber":"","storeSettings":{"returnPolicy":"","termsOfService":"","privacyPolicy":"","expressCheckout":true,"continueShoppingLinkUrl":"/","useLightCart":false,"showNoteField":false,"shippingCountryDefaultValue":"US","billToShippingDefaultValue":false,"showShippingPhoneNumber":true,"isShippingPhoneRequired":false,"showBillingPhoneNumber":true,"isBillingPhoneRequired":false,"currenciesSupported":["USD","AUD","CAD","CHF","DKK","EUR","GBP","NOK","SEK"],"defaultCurrency":"USD","selectedCurrency":"USD","measurementStandard":1,"showCustomCheckoutForm":false,"checkoutPageMarketingOptInEnabled":false,"enableMailingListOptInByDefault":false,"sameAsRetailLocation":false,"merchandisingSettings":{"scarcityEnabledOnProductItems":false,"scarcityEnabledOnProductBlocks":false,"scarcityMessageType":"DEFAULT_SCARCITY_MESSAGE","scarcityThreshold":10,"multipleQuantityAllowedForServices":true,"restockNotificationsEnabled":false,"restockNotificationsMailingListSignUpEnabled":false,"relatedProductsEnabled":false,"relatedProductsOrdering":"random","soldOutVariantsDropdownDisabled":false,"productComposerOptedIn":false,"productComposerABTestOptedOut":false,"productReviewsEnabled":false,"displayImportedProductReviewsEnabled":false,"hasOptedToCollectNativeReviews":false},"minimumOrderSubtotalEnabled":false,"isLive":true,"multipleQuantityAllowedForServices":true},"useEscapeKeyToLogin":true,"ssBadgeType":1,"ssBadgePosition":4,"ssBadgeVisibility":1,"ssBadgeDevices":1,"pinterestOverlayOptions":{"mode":"disabled"},"userAccountsSettings":{"loginAllowed":true,"signupAllowed":true}},"cookieSettings":{"isCookieBannerEnabled":false,"isRestrictiveCookiePolicyEnabled":false,"cookieBannerText":"","cookieBannerTheme":"","cookieBannerVariant":"","cookieBannerPosition":"","cookieBannerCtaVariant":"","cookieBannerCtaText":"","cookieBannerAcceptType":"OPT_IN","cookieBannerOptOutCtaText":"","cookieBannerHasOptOut":false,"cookieBannerHasManageCookies":true,"cookieBannerManageCookiesLabel":"","cookieBannerSavedPreferencesText":"","cookieBannerSavedPreferencesLayout":"PILL"},"websiteCloneable":false,"collection":{"title":"Blog","id":"53a64ceee4b0d3d42b2c7856","fullUrl":"/blog","publicCommentCount":0,"type":1,"permissionType":1},"item":{"title":"FinSpy VM Unpacking Tutorial Part 3: Devirtualization","id":"5a8dc6a9c83025e2bdf41f66","fullUrl":"/blog/2018/2/21/finspy-vm-unpacking-tutorial-part-3-devirtualization","publicCommentCount":0,"commentState":1,"recordType":1},"subscribed":false,"appDomain":"squarespace.com","templateTweakable":true,"tweakJSON":{"outerPadding":"100px","pagePadding":"80px","product-gallery-auto-crop":"true","product-image-auto-crop":"true","topPadding":"80px","tweak-v1-related-products-title-spacing":"50px"},"templateId":"50521cf884aeb45fa5cfdb80","templateVersion":"7","pageFeatures":[1,2,4],"gmRenderKey":"QUl6YVN5Q0JUUk9xNkx1dkZfSUUxcjQ2LVQ0QWVUU1YtMGQ3bXk4","templateScriptsRootUrl":"https://static1.squarespace.com/static/ta/5052176b84aeb45fa5cfcc83/961/scripts/","impersonatedSession":false,"demoCollections":[{"collectionId":"5052176b84aeb45fa5cfcc94","deleted":false}],"tzData":{"zones":[[-480,"US","P%sT",null]],"rules":{"US":[[1967,2006,null,"Oct","lastSun","2:00","0","S"],[1987,2006,null,"Apr","Sun>=1","2:00","1:00","D"],[2007,"max",null,"Mar","Sun>=8","2:00","1:00","D"],[2007,"max",null,"Nov","Sun>=1","2:00","0","S"]]}},"showAnnouncementBar":false,"recaptchaEnterpriseContext":{"recaptchaEnterpriseSiteKey":"6LdDFQwjAAAAAPigEvvPgEVbb7QBm-TkVJdDTlAv"},"i18nContext":{"timeZoneData":{"id":"America/Los_Angeles","name":"Pacific Time"}},"env":"PRODUCTION"};</script><script>Squarespace.load(window);</script>
<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://www.msreverseengineering.com/blog?format=rss" />
<script type="application/ld+json">{"url":"https://www.msreverseengineering.com","name":"M\u00F6bius Strip Reverse Engineering","description":"","@context":"http://schema.org","@type":"WebSite"}</script><script type="application/ld+json">{"address":"","@context":"http://schema.org","@type":"LocalBusiness"}</script><script type="application/ld+json">{"name":"FinSpy VM Unpacking Tutorial Part 3: Devirtualization \u2014 M\u00F6bius Strip Reverse Engineering","url":"https://www.msreverseengineering.com/blog/2018/2/21/finspy-vm-unpacking-tutorial-part-3-devirtualization","datePublished":"2018-02-21T13:14:59-0800","dateModified":"2018-03-02T12:46:48-0800","headline":"FinSpy VM Unpacking Tutorial Part 3: Devirtualization","author":"Rolf Rolles","publisher":{"name":"M\u00F6bius Strip Reverse Engineering","logo":{"@type":"ImageObject"},"@context":"http://schema.org","@type":"Organization"},"@context":"http://schema.org","@type":"Article"}</script><link rel="stylesheet" type="text/css" href="https://static1.squarespace.com/static/sitecss/53a64cc2e4b0c63fc41a3320/53/50521cf884aeb45fa5cfdb80/53a64cc2e4b0c63fc41a3324/961/site.css"/><script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script><script>Static.COOKIE_BANNER_CAPABLE = true;</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53862034-1"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('set', 'developer_id.dZjQwMz', true);gtag('config', 'UA-53862034-1');</script><!-- End of Squarespace Headers -->
  <script src="https://static1.squarespace.com/static/ta/5052176b84aeb45fa5cfcc83/961/scripts/site-bundle.js" type="text/javascript"></script>
</head>

<body class="show-products-category-navigation   page-borders-thick canvas-style-normal  header-subtitle-address banner-alignment-center blog-layout-center project-layout-left-sidebar thumbnails-on-open-page-show-all social-icon-style-round    hide-page-title       event-thumbnails event-thumbnail-size-32-standard event-date-label event-date-label-time event-list-show-cats event-list-date event-list-time event-list-address   event-icalgcal-links  event-excerpts  event-item-back-link    product-list-titles-under product-list-alignment-center product-item-size-32-standard product-image-auto-crop product-gallery-size-11-square product-gallery-auto-crop show-product-price show-product-item-nav product-social-sharing tweak-v1-related-products-image-aspect-ratio-11-square tweak-v1-related-products-details-alignment-center newsletter-style-dark  opentable-style-light small-button-style-solid small-button-shape-square medium-button-style-solid medium-button-shape-square large-button-style-solid large-button-shape-square image-block-poster-text-alignment-center image-block-card-dynamic-font-sizing image-block-card-content-position-center image-block-card-text-alignment-left image-block-overlap-dynamic-font-sizing image-block-overlap-content-position-center image-block-overlap-text-alignment-left image-block-collage-dynamic-font-sizing image-block-collage-content-position-top image-block-collage-text-alignment-left image-block-stack-dynamic-font-sizing image-block-stack-text-alignment-left button-style-outline button-corner-style-square tweak-product-quick-view-button-style-floating tweak-product-quick-view-button-position-bottom tweak-product-quick-view-lightbox-excerpt-display-truncate tweak-product-quick-view-lightbox-show-arrows tweak-product-quick-view-lightbox-show-close-button tweak-product-quick-view-lightbox-controls-weight-light native-currency-code-usd collection-53a64ceee4b0d3d42b2c7856 view-item collection-type-blog collection-layout-default mobile-style-available site-title" id="item-5a8dc6a9c83025e2bdf41f66">

  <div id="canvas">

    <div id="mobileNav" class="">
      <div class="wrapper">
        <nav class="main-nav mobileNav"><ul>
  
    

        <li class="page-collection">

          

            
              <a href="/training-classes">Training Classes</a>
            

            


          

        </li>

    

        <li class="page-collection">

          

            
              <a href="/research">Research</a>
            

            


          

        </li>

    

        <li class="blog-collection active-link">

          

            
              <a href="/blog">Blog</a>
            

            


          

        </li>

    

        <li class="page-collection">

          

            
              <a href="/contact">Contact</a>
            

            


          

        </li>

    
    
      <li class="user-account-link">
        <a href="#">
          <span class="sign-in">Sign In</span>
          <span class="my-account">My Account</span>
        </a>
      </li>
    
  
</ul>
</nav>

      </div>
    </div>
    <div id="mobileMenuLink"><a>Menu</a></div>

    <header id="header" class="clear">

    

      <div id="upper-logo">
        <h1 class="logo" data-content-field="site-title">
          <a href="/">Möbius Strip Reverse Engineering</a>
        </h1>
      </div>
      <script type="module">
      if (parseInt(Y.one('body').getComputedStyle('width'),10) <= 640) {
        Y.use('squarespace-ui-base', function(Y) {
          Y.one("#upper-logo .logo").plug(Y.Squarespace.TextShrink, {
            parentEl: Y.one('#upper-logo')
          });
        });
      }
      </script>

      
      <div class="site-info" data-content-field="business-information">
        <div class="site-address">Street Address</div>
        <div class="site-city-state">City, State, Zip</div>
        <div class="site-phone">Phone Number</div>
      </div>
      

      <div class="site-tag-line">
        <span>Reverse Engineering Training and Consulting Services</span>
      </div>

      <div class="custom-info">
        <div class="sqs-layout sqs-grid-12 columns-12" data-layout-label="Header Subtitle: Custom Content" data-type="block-field" data-updated-on="1381761023501" id="customInfoBlock"><div class="row sqs-row"><div class="col sqs-col-12 span-12"><div class="sqs-block html-block sqs-block-html" data-block-type="2" id="block-81eee4bbda3d9efd0834"><div class="sqs-block-content">

<div class="sqs-html-content">
  <p class="text-align-center">Your Custom Text Here</p>
</div>






















</div></div></div></div></div>
      </div>

      <div id="lower-logo">
        <h1 class="logo" data-content-field="site-title"><a href="/">Möbius Strip Reverse Engineering</a></h1>
      </div>
      <script type="module">
        Y.use('squarespace-ui-base', function(Y) {
          Y.one("#lower-logo .logo").plug(Y.Squarespace.TextShrink, {
            parentEl: Y.one('#lower-logo')
          });
        });
      </script>

    
      <div id="topNav">
  <nav class="main-nav" data-content-field="navigation">
    <ul>
    
      

          <li class="page-collection">

            

              
                <a href="/training-classes">Training Classes</a>
              

              


            

          </li>

      

          <li class="page-collection">

            

              
                <a href="/research">Research</a>
              

              


            

          </li>

      

          <li class="blog-collection active-link">

            

              
                <a href="/blog">Blog</a>
              

              


            

          </li>

      

          <li class="page-collection">

            

              
                <a href="/contact">Contact</a>
              

              


            

          </li>

      
      
        <li class="user-account-link">
          <a href="#">
            <span class="sign-in">Sign In</span>
            <span class="my-account">My Account</span>
          </a>
        </li>
      
    
  </ul>
  <div class="page-divider"></div>
  </nav>
</div>


    </header>

    <div class="page-divider top-divider"></div>

    <!-- // page image or divider -->
    
      
        
      
    

    <section id="page" class="clear" role="main" data-content-field="main-content" data-collection-id="53a64ceee4b0d3d42b2c7856" data-collection-id="53a64ceee4b0d3d42b2c7856" data-edit-main-image="Banner" >

      <!-- // CATEGORY NAV -->
      

      <div class="article-wrapper">



  <article class="hentry author-rolf-rolles post-type-text" id="article-5a8dc6a9c83025e2bdf41f66" data-item-id="5a8dc6a9c83025e2bdf41f66">

    <!--POST HEADER-->

    <header>
  		<h1 class="entry-title" itemprop="headline" data-content-field="title">
        
          <a href="/blog/2018/2/21/finspy-vm-unpacking-tutorial-part-3-devirtualization">FinSpy VM Unpacking Tutorial Part 3: Devirtualization</a>
        
      </h1>
      <div class="meta">
        <span class="date"><time class="published dt-published" datetime="2018-02-21" itemprop="datePublished" pubdate>February 21, 2018</time></span>
        <span class="author"><a href="/blog?author=5111cf9ee4b0a36262da10df" rel="author">Rolf Rolles</a></span>
      </div>
    </header>

    <!--SPECIAL CONTENT-->

    

    <!--POST BODY-->

    <div class="body entry-content"><div class="sqs-layout sqs-grid-12 columns-12" data-layout-label="Post Body" data-type="item" data-updated-on="1519241187882" id="item-5a8dc6a9c83025e2bdf41f66"><div class="row sqs-row"><div class="col sqs-col-12 span-12"><div class="sqs-block html-block sqs-block-html" data-block-type="2" id="block-f4cbd54c385061d0c94b"><div class="sqs-block-content">

<div class="sqs-html-content">
  <h1>1. Overview</h1><p>This is the third and final part in my series on statically unpacking the FinSpy VM. After having deobfuscated the x86 implementation of FinSpy in <a target="_blank" href="http://www.msreverseengineering.com/blog/2018/1/23/a-walk-through-tutorial-with-code-on-statically-unpacking-the-finspy-vm-part-one-x86-deobfuscation">part one</a>&nbsp;and after having analyzed the VM and written a disassembler for the bytecode format for the particular sample in question in <a target="_blank" href="http://www.msreverseengineering.com/blog/2018/1/31/finspy-vm-part-2-vm-analysis-and-bytecode-disassembly">part two</a>, we are now tasked with reconstructing x86 code corresponding to the pre-virtualized code. As before, the files are in the GitHub repository <a target="_blank" href="https://github.com/RolfRolles/FinSpyVM/">here</a>. Of note:</p><ul><li>The IDB with the devirtualized code added, and mostly analyzed: <a target="_blank" href="https://github.com/RolfRolles/FinSpyVM/blob/master/VMDevirtualization/BlackOasis-WithDevirtualization.idb">here</a></li><li>The devirtualization program: <a target="_blank" href="https://github.com/RolfRolles/FinSpyVM/tree/master/VMDisassembler/Tmp">here</a></li><li>FinSpy VM bytecode disassembly listings with various simplifications: <a target="_blank" href="https://github.com/RolfRolles/FinSpyVM/tree/master/VMProgram">here</a></li><li>Binary files for the devirtualized code: <a target="_blank" href="https://github.com/RolfRolles/FinSpyVM/tree/master/VMDevirtualization">here</a></li></ul><p>Because the FinSpy VM is a weak and ineffective software protection, unpacking it is not very difficult. Over half of the VM instructions in the bytecode program for the sample we're analyzing already contain raw x86 machine code. It turns out that FinSpy only truly virtualizes a handful of x86 instruction types, and that simple pattern-matching is effective in reconstructing the original code. It's perhaps the easiest software protection I know of worthy of being called a "virtualization obfuscator" -- and that makes it good practice for the difficult ones.&nbsp;</p><p>As with <a target="_blank" href="http://www.msreverseengineering.com/blog/2018/1/23/a-walk-through-tutorial-with-code-on-statically-unpacking-the-finspy-vm-part-one-x86-deobfuscation">part one</a>, I am attempting to write this in a walk-through tutorial style. We start from first principles in inspecting the FinSpy VM bytecode disassembly listing, and show all of the steps (along with the code I wrote) along the way. Hopefully I've managed to capture the process of observation, evaluation of design considerations, actions taken including mis-steps, and above all, the iterative, trial-and-error nature of the affair.</p><h1>2. Organizational Overview</h1><p>This part ended up being longer and more difficult to write than expected. In fact, writing this document as a tutorial was considerably more difficult than doing the work in the first place. I hope the effort pays off in terms of educational value. Because I personally don't enjoy huge documents whose sections aren't well-segregated from one another, I have decided to split the devirtualization process, and also this document, into a number of "phases", each in its own individual blog entry. All entries are currently online and available for reading; links to them are immediately below. Each individual part links to the code and binary artifacts used in that phase.</p><p>Here are the contents of each phase in brief, along with links to the individual parts:</p><ol><li><a target="_blank" href="http://www.msreverseengineering.com/blog/2018/2/21/wsbjxrs1jjw7qi4trk9t3qy6hr7dye">Part #3, Phase #1: analyzing and deobfuscating FinSpy VM bytecode programs</a>. In <a target="_blank" href="http://www.msreverseengineering.com/blog/2018/1/31/finspy-vm-part-2-vm-analysis-and-bytecode-disassembly">part two</a>, we analyzed the FinSpy VM and its instruction set, and ultimately wrote a disassembler for FinSpy VM programs. This phase begins by reviewing the FinSpy VM instruction set. Next, we work from first principles in analyzing the FinSpy VM bytecode program. First we add a useful feature to our FinSpy VM disassembler. Next, we analyze a set of VM instructions -- group #2, in the parlance -- used by the VM bytecode program for obfuscation purposes. We determine several patterns, and write code to detect and simplify instances of those patterns within FinSpy VM bytecode programs. After one more small tweak to the disassembler, the FinSpy VM bytecode program is now ready to be devirtualized back into x86 machine code.</li><li><a target="_blank" href="http://www.msreverseengineering.com/blog/2018/2/21/devirtualizing-finspy-phase-2-first-attempt-at-devirtualization">Part #3, Phase #2: initial devirtualization</a>. The previous phase left the FinSpy VM bytecode program in a suitable form for devirtualization. This phase begins by discussing the theory behind devirtualizing the individual FinSpy VM instructions. Next, we write a tool to devirtualize FinSpy VM bytecode programs -- this tool takes as input the disassembly of a FinSpy VM program, and produces as output a blob of x86 machine code that no longer relies upon the VM. After producing output, we then inspect our initial results in devirtualization to determine a few deficiencies and remaining tasks before our devirtualization can be considered complete. This phase ends by fixing one of the issues revealed by inspecting the devirtualized output.</li><li><a target="_blank" href="http://www.msreverseengineering.com/blog/2018/2/21/devirtualizing-finspy-phase-3-fixing-the-function-related-issues">Part #3, Phase #3: devirtualizing function calls</a>. The devirtualization generated by the previous stage still has a few deficiencies that need to be fixed before the output is fully usable. As it turns out, all of these deficiencies relate to how the FinSpy VM deals with function calls and function pointers. We discuss the source of the difficulties and determine what needs to be done to fix the issues. Then we discuss a few strategies that we might employ to solve the problems, including a somewhat sophisticated one involving x86 emulation. We settle for something less than that.&nbsp;</li><li><a target="_blank" href="http://www.msreverseengineering.com/blog/2018/2/21/devirtualizing-finspy-phase-4-second-attempt-at-devirtualization">Part #3, Phase #4: second devirtualization</a>. The previous phase collected information about virtualized functions in preparation for a second attempt at devirtualization. This phase incorporates that information into the devirtualization process, and then re-inspects the devirtualized code for defects. After fixing one more remaining major issue and two small ones, we now have our complete devirtualized blob of x86 machine code for the FinSpy VM program in our sample. We trick IDA into loading our devirtualized code, and now our devirtualization journey is complete.&nbsp;</li></ol><p>After phase #4 was complete, I next completely analyzed the devirtualized FinSpy dropper binary. I may publish some techniques I saw that weren't widely documented, and I may publish a complete analysis of the dropper. However, that writing remains to be done, and is not part of this blog series on devirtualization.</p><p>Enjoy.</p>
</div>






















</div></div></div></div></div></div>
    


    <!--POST FOOTER-->

    <footer class="clear">
      <div class="meta">

        

        <div class="first meta-row">
          
          
        </div>

        <div class="second meta-row">
          <span class="squarespace-social-buttons inline-style" data-system-data-id="" data-asset-url="https://static1.squarespace.com/static/53a64cc2e4b0c63fc41a3320/53a64ceee4b0d3d42b2c7856/5a8dc6a9c83025e2bdf41f66/1520023608340/" data-record-type="1" data-full-url="/blog/2018/2/21/finspy-vm-unpacking-tutorial-part-3-devirtualization" data-title="FinSpy VM Unpacking Tutorial Part 3: Devirtualization"></span>
          
  <span class="sqs-simple-like" data-item-id="5a8dc6a9c83025e2bdf41f66" data-like-count="13">
    <span class="like-icon"></span>
    <span class="like-count"></span>
  </span>

        </div>

      </div>
    </footer>


  </article>



<!--PAGINATION-->


  <nav class="pagination clear">
      <a class="prev-item" href="/blog/2018/2/21/wsbjxrs1jjw7qi4trk9t3qy6hr7dye">&larr; FinSpy VM Unpacking Tutorial Part 3: Devirtualization. Phase #1: Deobfuscating FinSpy VM Bytecode Programs</a><a class="next-item" href="/blog/2018/1/31/finspy-vm-part-2-vm-analysis-and-bytecode-disassembly">FinSpy VM Part 2: VM Analysis and Bytecode Disassembly &rarr;</a>
  </nav>



  <!-- COMMENTS -->

  <section id="comments-5a8dc6a9c83025e2bdf41f66" class="comments-wrapper">
    
  <div class="squarespace-comments" id="comments-5a8dc6a9c83025e2bdf41f66" data-item-id="5a8dc6a9c83025e2bdf41f66" data-public-comment-count="0" data-comment-state="1"></div>

  </section>


</div><!-- /article-wrapper -->

<aside id="sidebar"><div class="sqs-layout sqs-grid-1 columns-1 empty" data-layout-label="Sidebar Content" data-type="block-field" id="sidebarBlocks"><div class="row sqs-row"><div class="col sqs-col-1 span-1"></div></div></div></aside>

    </section>

    <div class="sqs-layout sqs-grid-12 columns-12 empty" data-layout-label="Blog Footer Content" data-type="block-field" id="item-5a8dc6a9c83025e2bdf41f66"><div class="row sqs-row"><div class="col sqs-col-12 span-12"></div></div></div>

    <!-- <div class="page-divider bottom-divider"></div> -->

    <div class="info-footer-wrapper clear">
      <div class="info-footer">
      <div class="sqs-layout sqs-grid-12 columns-12 empty" data-layout-label="Info Footer Content" data-type="block-field" data-updated-on="1403654631747" id="infoFooterBlock"><div class="row sqs-row"><div class="col sqs-col-12 span-12"></div></div></div>
      
        
      
      </div>
    </div>

    <footer id="footer" class="clear">
      <div class="sqs-layout sqs-grid-12 columns-12" data-layout-label="Footer Content" data-type="block-field" data-updated-on="1357835131710" id="footerBlock"><div class="row sqs-row"><div class="col sqs-col-12 span-12"><div class="sqs-block html-block sqs-block-html" data-block-type="2" id="block-126febe67777dbcbc0b4"><div class="sqs-block-content">

<div class="sqs-html-content">
  <p class="text-align-center">Powered by <a href="http://www.squarespace.com" data-link-type="external">Squarespace</a></p>
</div>






















</div></div></div></div></div>
    </footer>

  </div>

  <div></div>

  <script data-sqs-type="imageloader-bootstrapper">if(window.ImageLoader) window.ImageLoader.bootstrap({}, document);</script><script>Squarespace.afterBodyLoad(Y);</script>




</body>

</html>
